<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Reading Statistics - Ë™≠Êõ∏</title>
  <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ccircle cx='50' cy='30' r='12' fill='%2326a641'/%3E%3Cpath d='M 50 42 L 45 55 L 40 75 M 50 42 L 55 55 L 60 75' stroke='%2326a641' stroke-width='4' fill='none' stroke-linecap='round'/%3E%3Crect x='25' y='50' width='20' height='28' rx='2' fill='%23c9d1d9' opacity='0.9'/%3E%3Crect x='55' y='50' width='20' height='28' rx='2' fill='%23c9d1d9' opacity='0.9'/%3E%3Crect x='48' y='50' width='4' height='28' fill='%2326a641'/%3E%3Cpath d='M 38 48 Q 32 50 28 52' stroke='%2326a641' stroke-width='3' fill='none' stroke-linecap='round'/%3E%3Cpath d='M 62 48 Q 68 50 72 52' stroke='%2326a641' stroke-width='3' fill='none' stroke-linecap='round'/%3E%3C/svg%3E">
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://fonts.googleapis.com/css2?family=Klee+One:wght@400;600&display=swap" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.0/chart.umd.min.js"></script>

  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    
    :root {
      --bg-primary: #0d1117;
      --bg-secondary: #161b22;
      --bg-tertiary: #21262d;
      --border-color: #30363d;
      --text-primary: #c9d1d9;
      --text-secondary: #8b949e;
      --accent-color: #238636;
      --accent-hover: #2ea043;
    }
    
    body {
      font-family: "Klee One", cursive;
      background: var(--bg-primary);
      color: var(--text-primary);
      padding: 40px 20px;
      min-height: 100vh;
    }
    body.theme-nord {
  --bg-primary: #2e3440;
  --bg-secondary: #3b4252;
  --bg-tertiary: #434c5e;
  --border-color: #4c566a;
  --text-primary: #eceff4;
  --text-secondary: #d8dee9;
  --accent-color: #88c0d0;
  --accent-hover: #8fbcbb;
}

body.theme-tokyo {
  --bg-primary: #1a1b26;
  --bg-secondary: #16161e;
  --bg-tertiary: #24283b;
  --border-color: #414868;
  --text-primary: #a9b1d6;
  --text-secondary: #565f89;
  --accent-color: #7aa2f7;
  --accent-hover: #7dcfff;
}

body.theme-dracula {
  --bg-primary: #282a36;
  --bg-secondary: #21222c;
  --bg-tertiary: #343746;
  --border-color: #44475a;
  --text-primary: #f8f8f2;
  --text-secondary: #6272a4;
  --accent-color: #ff5555;
  --accent-hover: #ff6e6e;
}

body.theme-everforest {
  --bg-primary: #fdf6e3;
  --bg-secondary: #f4f0d9;
  --bg-tertiary: #efebd4;
  --border-color: #e0dcc7;
  --text-primary: #5c6a72;
  --text-secondary: #939f91;
  --accent-color: #8da101;
  --accent-hover: #a7b901;
}

body.theme-onedark {
  --bg-primary: #282c34;
  --bg-secondary: #21252b;
  --bg-tertiary: #2c313c;
  --border-color: #3e4451;
  --text-primary: #abb2bf;
  --text-secondary: #5c6370;
  --accent-color: #98c379;
  --accent-hover: #b5cea8;
}

body.theme-nord-light {
  --bg-primary: #eceff4;
  --bg-secondary: #e5e9f0;
  --bg-tertiary: #d8dee9;
  --border-color: #c2c9d6;
  --text-primary: #2e3440;
  --text-secondary: #4c566a;
  --accent-color: #5e81ac;
  --accent-hover: #81a1c1;
}

body.theme-phoenix {
  --bg-primary: #170f1e;
  --bg-secondary: #1c1521;
  --bg-tertiary: #2b2032;
  --border-color: #3d2f47;
  --text-primary: #f5c2e7;
  --text-secondary: #988ba2;
  --accent-color: #cba6f7;
  --accent-hover: #d4b4f8;
}

body.theme-ereader {
  --bg-primary: #ffffff;
  --bg-secondary: #f5f5f5;
  --bg-tertiary: #e8e8e8;
  --border-color: #d0d0d0;
  --text-primary: #000000;
  --text-secondary: #666666;
  --accent-color: #333333;
  --accent-hover: #000000;
}

body.theme-everforest h1,
body.theme-nord-light h1,
body.theme-ereader h1 {
  color: var(--text-primary);
}
    .container {
      max-width: 1400px;
      margin: 0 auto;
    }

    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 32px;
    }

    h1 {
      font-size: 28px;
      font-weight: 700;
      color: #ffffff;
    }

    .back-btn {
      background: var(--bg-tertiary);
      border: 1px solid var(--border-color);
      color: var(--text-primary);
      padding: 10px 20px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
      text-decoration: none;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      transition: all 0.2s;
    }

    .back-btn:hover {
      background: var(--border-color);
      transform: translateX(-4px);
    }

    select {
      background: var(--bg-tertiary);
      border: 1px solid var(--border-color);
      color: var(--text-primary);
      padding: 8px 16px;
      border-radius: 6px;
      font-size: 14px;
      cursor: pointer;
      font-family: inherit;
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>üìä Reading Statistics</h1>
      <a href="index.html" class="back-btn">‚Üê Back to Heatmap</a>
    </header>

    <!-- Time Range Selector -->
    <div style="display: flex; gap: 12px; align-items: center; margin-bottom: 32px; padding: 20px; background: var(--bg-secondary); border-radius: 6px; border: 1px solid var(--border-color);">
      <span style="color: var(--text-secondary); font-size: 14px; font-weight: 600;">Time Range:</span>
      <select id="statsTimeRange" onchange="updateStatistics()">
        <option value="7">Last 7 days</option>
        <option value="30" selected>Last 30 days</option>
        <option value="90">Last 90 days</option>
        <option value="365">Last year</option>
        <option value="all">All time</option>
      </select>
    </div>

    <!-- Summary Cards -->
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 20px; margin-bottom: 32px;">
      <div style="background: var(--bg-secondary); padding: 24px; border-radius: 8px; border: 1px solid var(--border-color);">
        <div style="font-size: 13px; color: var(--text-secondary); margin-bottom: 8px; text-transform: uppercase;">Total Reading Time</div>
        <div style="font-size: 32px; font-weight: 600; color: var(--accent-color);" id="statTotalMinutes">0 min</div>
      </div>
      <div style="background: var(--bg-secondary); padding: 24px; border-radius: 8px; border: 1px solid var(--border-color);">
        <div style="font-size: 13px; color: var(--text-secondary); margin-bottom: 8px; text-transform: uppercase;">Total Characters</div>
        <div style="font-size: 32px; font-weight: 600; color: var(--accent-color);" id="statTotalChars">0</div>
      </div>
      <div style="background: var(--bg-secondary); padding: 24px; border-radius: 8px; border: 1px solid var(--border-color);">
        <div style="font-size: 13px; color: var(--text-secondary); margin-bottom: 8px; text-transform: uppercase;">Avg Speed</div>
        <div style="font-size: 32px; font-weight: 600; color: var(--accent-color);" id="statAvgSpeed">0 ch/min</div>
      </div>
      <div style="background: var(--bg-secondary); padding: 24px; border-radius: 8px; border: 1px solid var(--border-color);">
        <div style="font-size: 13px; color: var(--text-secondary); margin-bottom: 8px; text-transform: uppercase;">Reading Days</div>
        <div style="font-size: 32px; font-weight: 600; color: var(--accent-color);" id="statReadingDays">0</div>
      </div>
    </div>

    <!-- Charts Grid -->
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(500px, 1fr)); gap: 24px;">
      
      <div style="background: var(--bg-secondary); padding: 24px; border-radius: 8px; border: 1px solid var(--border-color);">
        <h3 style="font-size: 18px; margin-bottom: 20px;">Reading Speed Over Time</h3>
        <canvas id="speedChart"></canvas>
      </div>
      
      <div style="background: var(--bg-secondary); padding: 24px; border-radius: 8px; border: 1px solid var(--border-color);">
        <h3 style="font-size: 18px; margin-bottom: 20px;">Daily Reading Time</h3>
        <canvas id="dailyTimeChart"></canvas>
      </div>
      
      <div style="background: var(--bg-secondary); padding: 24px; border-radius: 8px; border: 1px solid var(--border-color);">
        <h3 style="font-size: 18px; margin-bottom: 20px;">Characters Read per Day</h3>
        <canvas id="dailyCharsChart"></canvas>
      </div>
      
      <div style="background: var(--bg-secondary); padding: 24px; border-radius: 8px; border: 1px solid var(--border-color);">
        <h3 style="font-size: 18px; margin-bottom: 20px;">Reading by Day of Week</h3>
        <canvas id="dayOfWeekChart"></canvas>
      </div>
      
      <div style="background: var(--bg-secondary); padding: 24px; border-radius: 8px; border: 1px solid var(--border-color);">
        <h3 style="font-size: 18px; margin-bottom: 20px;">Most Read Books</h3>
        <div id="topBooksList" style="max-height: 300px; overflow-y: auto;"></div>
      </div>
      
      <div style="background: var(--bg-secondary); padding: 24px; border-radius: 8px; border: 1px solid var(--border-color);">
        <h3 style="font-size: 18px; margin-bottom: 20px;">Reading Consistency</h3>
        <canvas id="consistencyChart"></canvas>
      </div>
      
    </div>
  </div>

  <script>
const STORAGE_KEY = 'reading_heatmap_data';
const GOALS_KEY = 'reading_heatmap_goals';
const BOOKS_KEY = 'reading_heatmap_books';
const THEME_KEY = 'reading_heatmap_theme';
const USER_KEY = 'reading_heatmap_user';

let data = [];
let dailyData = {};
let goals = [];
let recentBooks = [];
let currentUser = null;

function loadTheme() {
  const theme = localStorage.getItem(THEME_KEY) || 'default';
  document.body.className = theme === 'default' ? '' : `theme-${theme}`;
}

async function loadFromStorage() {
  try {
    const stored = localStorage.getItem(STORAGE_KEY);
    if (stored) {
      window.data = data = JSON.parse(stored);
    }
    
    const storedGoals = localStorage.getItem(GOALS_KEY);
    if (storedGoals) {
      window.goals = goals = JSON.parse(storedGoals);
    }
    
    const storedBooks = localStorage.getItem(BOOKS_KEY);
    if (storedBooks) {
      window.recentBooks = recentBooks = JSON.parse(storedBooks);
    }
  } catch (e) {
    console.error('Error loading data:', e);
  }
  
  aggregateData();
}

function aggregateData() {
  window.dailyData = dailyData = {};
  const dataArray = window.data || data || [];
  dataArray.forEach(item => {
    if (!dailyData[item.date]) {
      dailyData[item.date] = { minutes: 0, characters: 0, titles: [] };
    }
    dailyData[item.date].minutes += item.minutes;
    dailyData[item.date].characters += item.characters;
    if (item.title && !dailyData[item.date].titles.includes(item.title)) {
      dailyData[item.date].titles.push(item.title);
    }
  });
  window.dailyData = dailyData;
}

function updateStatistics() {
  const timeRange = document.getElementById('statsTimeRange').value;
  const days = timeRange === 'all' ? 9999 : parseInt(timeRange);
  
  const endDate = new Date();
  const startDate = new Date();
  startDate.setDate(startDate.getDate() - days);
  
  const filteredData = {};
  Object.keys(dailyData).forEach(date => {
    const dateObj = new Date(date + 'T00:00:00');
    if (dateObj >= startDate && dateObj <= endDate) {
      filteredData[date] = dailyData[date];
    }
  });
  
  let totalMinutes = 0;
  let totalCharacters = 0;
  let readingDays = 0;
  
  Object.values(filteredData).forEach(day => {
    totalMinutes += day.minutes || 0;
    totalCharacters += day.characters || 0;
    if ((day.minutes || 0) > 0 || (day.characters || 0) > 0) {
      readingDays++;
    }
  });
  
  const avgSpeed = totalMinutes > 0 ? Math.round(totalCharacters / totalMinutes) : 0;
  
  document.getElementById('statTotalMinutes').textContent = totalMinutes.toLocaleString() + ' min';
  document.getElementById('statTotalChars').textContent = totalCharacters.toLocaleString();
  document.getElementById('statAvgSpeed').textContent = avgSpeed.toLocaleString() + ' ch/min';
  document.getElementById('statReadingDays').textContent = readingDays;
  
  renderSpeedChart(filteredData);
  renderDailyTimeChart(filteredData);
  renderDailyCharsChart(filteredData);
  renderDayOfWeekChart(filteredData);
  renderTopBooks(filteredData);
  renderConsistencyChart(filteredData);
}

let chartInstances = {};

function destroyChart(chartId) {
  if (chartInstances[chartId]) {
    chartInstances[chartId].destroy();
    delete chartInstances[chartId];
  }
}

function renderSpeedChart(filteredData) {
  destroyChart('speedChart');
  
  const dates = Object.keys(filteredData).sort();
  const speeds = dates.map(date => {
    const day = filteredData[date];
    return day.minutes > 0 ? Math.round(day.characters / day.minutes) : 0;
  });
  
  const ctx = document.getElementById('speedChart');
  chartInstances['speedChart'] = new Chart(ctx, {
    type: 'line',
    data: {
      labels: dates.map(d => new Date(d).toLocaleDateString('en-US', { month: 'short', day: 'numeric' })),
      datasets: [{
        label: 'Characters per Minute',
        data: speeds,
        borderColor: 'rgb(35, 134, 54)',
        backgroundColor: 'rgba(35, 134, 54, 0.1)',
        tension: 0.4,
        fill: true
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: true,
      plugins: { legend: { display: false } },
      scales: {
        y: { beginAtZero: true, ticks: { color: '#8b949e' } },
        x: { ticks: { color: '#8b949e', maxRotation: 45, minRotation: 45 } }
      }
    }
  });
}

function renderDailyTimeChart(filteredData) {
  destroyChart('dailyTimeChart');
  
  const dates = Object.keys(filteredData).sort();
  const minutes = dates.map(date => filteredData[date].minutes || 0);
  
  const ctx = document.getElementById('dailyTimeChart');
  chartInstances['dailyTimeChart'] = new Chart(ctx, {
    type: 'bar',
    data: {
      labels: dates.map(d => new Date(d).toLocaleDateString('en-US', { month: 'short', day: 'numeric' })),
      datasets: [{
        label: 'Minutes',
        data: minutes,
        backgroundColor: 'rgba(35, 134, 54, 0.8)'
      }]
    },
    options: {
      responsive: true,
      plugins: { legend: { display: false } },
      scales: {
        y: { beginAtZero: true, ticks: { color: '#8b949e' } },
        x: { ticks: { color: '#8b949e', maxRotation: 45, minRotation: 45 } }
      }
    }
  });
}

function renderDailyCharsChart(filteredData) {
  destroyChart('dailyCharsChart');
  
  const dates = Object.keys(filteredData).sort();
  const characters = dates.map(date => filteredData[date].characters || 0);
  
  const ctx = document.getElementById('dailyCharsChart');
  chartInstances['dailyCharsChart'] = new Chart(ctx, {
    type: 'bar',
    data: {
      labels: dates.map(d => new Date(d).toLocaleDateString('en-US', { month: 'short', day: 'numeric' })),
      datasets: [{
        label: 'Characters',
        data: characters,
        backgroundColor: 'rgba(57, 211, 83, 0.8)'
      }]
    },
    options: {
      responsive: true,
      plugins: { legend: { display: false } },
      scales: {
        y: { 
          beginAtZero: true, 
          ticks: { 
            color: '#8b949e',
            callback: v => v >= 1000 ? (v / 1000).toFixed(1) + 'k' : v
          } 
        },
        x: { ticks: { color: '#8b949e', maxRotation: 45, minRotation: 45 } }
      }
    }
  });
}

function renderDayOfWeekChart(filteredData) {
  destroyChart('dayOfWeekChart');
  
  const dayStats = {
    'Mon': { minutes: 0, count: 0 }, 'Tue': { minutes: 0, count: 0 }, 'Wed': { minutes: 0, count: 0 },
    'Thu': { minutes: 0, count: 0 }, 'Fri': { minutes: 0, count: 0 }, 'Sat': { minutes: 0, count: 0 }, 'Sun': { minutes: 0, count: 0 }
  };
  
  Object.keys(filteredData).forEach(date => {
    const dayName = new Date(date + 'T00:00:00').toLocaleDateString('en-US', { weekday: 'short' });
    dayStats[dayName].minutes += filteredData[date].minutes || 0;
    dayStats[dayName].count++;
  });
  
  const days = ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'];
  const avgMinutes = days.map(day => dayStats[day].count > 0 ? Math.round(dayStats[day].minutes / dayStats[day].count) : 0);
  
  const ctx = document.getElementById('dayOfWeekChart');
  chartInstances['dayOfWeekChart'] = new Chart(ctx, {
    type: 'bar',
    data: {
      labels: days,
      datasets: [{
        label: 'Avg Minutes',
        data: avgMinutes,
        backgroundColor: ['rgba(35, 134, 54, 0.8)', 'rgba(38, 166, 65, 0.8)', 'rgba(57, 211, 83, 0.8)', 'rgba(35, 134, 54, 0.8)', 'rgba(38, 166, 65, 0.8)', 'rgba(57, 211, 83, 0.8)', 'rgba(35, 134, 54, 0.8)']
      }]
    },
    options: {
      responsive: true,
      plugins: { legend: { display: false } },
      scales: {
        y: { beginAtZero: true, ticks: { color: '#8b949e' } },
        x: { ticks: { color: '#8b949e' } }
      }
    }
  });
}

function renderTopBooks(filteredData) {
  const bookStats = {};
  
  Object.values(filteredData).forEach(day => {
    day.titles.forEach(title => {
      if (!bookStats[title]) bookStats[title] = { minutes: 0, characters: 0, days: 0 };
      bookStats[title].minutes += day.minutes || 0;
      bookStats[title].characters += day.characters || 0;
      bookStats[title].days++;
    });
  });
  
  const sortedBooks = Object.entries(bookStats).sort((a, b) => b[1].minutes - a[1].minutes).slice(0, 10);
  const container = document.getElementById('topBooksList');
  
  if (sortedBooks.length === 0) {
    container.innerHTML = '<div style="color: #8b949e; padding: 20px; text-align: center;">No books tracked yet</div>';
    return;
  }
  
  container.innerHTML = sortedBooks.map(([title, stats], i) => `
    <div style="padding: 10px; background: var(--bg-tertiary); border-radius: 4px; margin-bottom: 8px;">
      <div style="font-weight: 600; margin-bottom: 4px;">${i + 1}. ${title}</div>
      <div style="font-size: 12px; color: #8b949e;">${stats.minutes} min ‚Ä¢ ${stats.characters.toLocaleString()} chars ‚Ä¢ ${stats.days} days</div>
    </div>
  `).join('');
}

function renderConsistencyChart(filteredData) {
  destroyChart('consistencyChart');
  
  const dates = Object.keys(filteredData).sort();
  const hasReading = dates.map(date => (filteredData[date].minutes > 0 || filteredData[date].characters > 0) ? 1 : 0);
  
  const rolling7Day = [];
  for (let i = 0; i < hasReading.length; i++) {
    const start = Math.max(0, i - 6);
    const slice = hasReading.slice(start, i + 1);
    rolling7Day.push(Math.round((slice.reduce((a, b) => a + b, 0) / slice.length) * 100));
  }
  
  const ctx = document.getElementById('consistencyChart');
  chartInstances['consistencyChart'] = new Chart(ctx, {
    type: 'line',
    data: {
      labels: dates.map(d => new Date(d).toLocaleDateString('en-US', { month: 'short', day: 'numeric' })),
      datasets: [{
        label: '7-Day Consistency %',
        data: rolling7Day,
        borderColor: 'rgb(57, 211, 83)',
        backgroundColor: 'rgba(57, 211, 83, 0.1)',
        tension: 0.4,
        fill: true
      }]
    },
    options: {
      responsive: true,
      plugins: { legend: { display: false } },
      scales: {
        y: { beginAtZero: true, max: 100, ticks: { color: '#8b949e', callback: v => v + '%' } },
        x: { ticks: { color: '#8b949e', maxRotation: 45, minRotation: 45 } }
      }
    }
  });
}

window.onload = function() {
  loadTheme();
  loadFromStorage();
  updateStatistics();
};
  </script>
</body>
</html>