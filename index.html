<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Reading Heatmap</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://fonts.googleapis.com/css2?family=Klee+One:wght@400;600&display=swap" rel="stylesheet">
  


  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    
    :root {
      --bg-primary: #0d1117;
      --bg-secondary: #161b22;
      --bg-tertiary: #21262d;
      --border-color: #30363d;
      --text-primary: #c9d1d9;
      --text-secondary: #8b949e;
      --accent-color: #238636;
      --accent-hover: #2ea043;
      --danger-color: #da3633;
      --danger-hover: #f85149;
      --level-0: #161b22;
      --level-1: #0e4429;
      --level-2: #006d32;
      --level-3: #26a641;
      --level-4: #39d353;
    }
    
    body.theme-nord {
      --bg-primary: #2e3440;
      --bg-secondary: #3b4252;
      --bg-tertiary: #434c5e;
      --border-color: #4c566a;
      --text-primary: #eceff4;
      --text-secondary: #d8dee9;
      --accent-color: #88c0d0;
      --accent-hover: #8fbcbb;
      --danger-color: #bf616a;
      --danger-hover: #d08770;
      --level-0: #3b4252;
      --level-1: #5e81ac;
      --level-2: #81a1c1;
      --level-3: #88c0d0;
      --level-4: #8fbcbb;
    }
    
    body.theme-tokyo {
      --bg-primary: #1a1b26;
      --bg-secondary: #24283b;
      --bg-tertiary: #414868;
      --border-color: #565f89;
      --text-primary: #c0caf5;
      --text-secondary: #9aa5ce;
      --accent-color: #7aa2f7;
      --accent-hover: #7dcfff;
      --danger-color: #f7768e;
      --danger-hover: #ff9e64;
      --level-0: #24283b;
      --level-1: #3d59a1;
      --level-2: #7aa2f7;
      --level-3: #7dcfff;
      --level-4: #2ac3de;
    }
    
    body.theme-dracula {
      --bg-primary: #282a36;
      --bg-secondary: #44475a;
      --bg-tertiary: #6272a4;
      --border-color: #6272a4;
      --text-primary: #f8f8f2;
      --text-secondary: #bd93f9;
      --accent-color: #50fa7b;
      --accent-hover: #8be9fd;
      --danger-color: #ff5555;
      --danger-hover: #ff6e6e;
      --level-0: #44475a;
      --level-1: #6272a4;
      --level-2: #8be9fd;
      --level-3: #50fa7b;
      --level-4: #f1fa8c;
    }
    
    body {
      font-family: "Klee One", cursive;
      background: var(--bg-primary);
      color: var(--text-primary);
      padding: 40px 20px;
      min-height: 100vh;
      overflow-x: hidden;
    }
    
    html {
      overflow-x: hidden;
      background: var(--bg-primary);
    }

    .container {
      max-width: 1100px;
      margin: 0 auto;
    }

    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 32px;
    }

    h1 {
      font-size: 24px;
      font-weight: 700;
      color: #ffffff;
    }

    .header-actions {
      display: flex;
      gap: 8px;
      align-items: center;
    }

    .icon-btn {
      background: transparent;
      border: none;
      color: var(--text-secondary);
      padding: 8px;
      cursor: pointer;
      border-radius: 6px;
      transition: all 0.2s;
      font-size: 18px;
    }

    .icon-btn:hover {
      background: var(--bg-tertiary);
      color: var(--text-primary);
    }
    
    .user-profile {
      display: flex;
      align-items: center;
      gap: 10px;
      background: var(--bg-tertiary);
      padding: 6px 12px;
      border-radius: 20px;
      cursor: pointer;
    }
    
    .user-profile:hover {
      background: var(--border-color);
    }
    
    .user-avatar {
      width: 28px;
      height: 28px;
      border-radius: 50%;
    }
    
    .user-name {
      font-size: 14px;
      color: var(--text-primary);
    }

    .controls {
      display: flex;
      gap: 12px;
      margin-bottom: 24px;
      align-items: center;
    }

    .btn {
      background: var(--bg-tertiary);
      border: 1px solid var(--border-color);
      color: var(--text-primary);
      padding: 8px 14px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 13px;
      transition: all 0.2s;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
    }

    .btn:hover {
      background: var(--border-color);
      border-color: var(--text-secondary);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.4);
    }

    select, input[type="number"] {
      background: var(--bg-secondary);
      border: 1px solid var(--border-color);
      color: var(--text-primary);
      padding: 8px 12px;
      border-radius: 6px;
      font-size: 13px;
      box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.3);
      transition: all 0.2s;
    }

    .heatmap-panel {
      background: var(--bg-primary);
      border: 1px solid var(--border-color);
      border-radius: 6px;
      padding: 24px;
      margin-bottom: 20px;
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.4);
    }

    .day-labels {
      display: flex;
      flex-direction: column;
      gap: 5px;
      font-size: 12px;
      color: var(--text-secondary);
      margin-right: 8px;
      padding-top: 24px;
    }

    .day-label {
      height: 14px;
      line-height: 14px;
      display: flex;
      align-items: center;
    }
    
    .day-label:nth-child(2),
    .day-label:nth-child(4),
    .day-label:nth-child(6),
    .day-label:nth-child(7) {
      visibility: hidden;
    }

    .calendar-wrapper {
      display: flex;
      overflow-x: auto;
      padding-bottom: 4px;
      scrollbar-width: none;
    }

    .calendar-wrapper::-webkit-scrollbar {
      display: none;
    }

    .calendar {
      display: flex;
      gap: 5px;
    }

    .month {
      display: flex;
      flex-direction: column;
    }

    .month-label {
      font-size: 11px;
      font-weight: 400;
      color: var(--text-secondary);
      margin-bottom: 4px;
      height: 16px;
    }

    .weeks {
      display: flex;
      gap: 5px;
    }

    .week {
      display: flex;
      flex-direction: column;
      gap: 5px;
    }

    .week.partial-start {
      padding-top: calc(var(--offset, 0) * (14px + 6px));
    }

    .day {
      width: 14px;
      height: 14px;
      border-radius: 2px;
      cursor: pointer;
      transition: all 0.15s;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.4);
    }

    .day.empty {
      background: var(--level-0);
      border: 1px solid var(--border-color);
    }

    .day.level-1 { background: var(--level-1); }
    .day.level-2 { background: var(--level-2); }
    .day.level-3 { background: var(--level-3); }
    .day.level-4 { background: var(--level-4); }

    .day:hover {
      outline: 1.5px solid rgba(255, 255, 255, 0.7);
      outline-offset: 1px;
      transform: scale(1.2);
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.5);
    }

    .day.today {
      outline: 2px solid var(--accent-color);
      outline-offset: 1px;
    }

    .stats-section {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: 16px;
    }

    .stats {
      display: flex;
      flex-direction: column;
      gap: 4px;
      font-size: 13px;
      color: var(--text-secondary);
    }
    
    .stat-line {
      display: flex;
      gap: 4px;
    }

    .stat-value {
      color: var(--text-primary);
      font-weight: 600;
    }

    .log-btn {
      background: var(--accent-color);
      border: none;
      color: #ffffff;
      padding: 10px 20px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 13px;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 6px;
      transition: all 0.2s;
      box-shadow: 0 4px 12px rgba(35, 134, 54, 0.3);
    }

    .log-btn:hover {
      background: var(--accent-hover);
      box-shadow: 0 6px 16px rgba(46, 160, 67, 0.4);
      transform: translateY(-2px);
    }

    .tooltip {
      position: fixed;
      background: var(--bg-tertiary);
      border: 1px solid var(--border-color);
      border-radius: 6px;
      padding: 10px 12px;
      font-size: 12px;
      pointer-events: none;
      z-index: 1000;
      display: none;
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.6);
      max-width: 250px;
    }

    .tooltip.show {
      display: block;
    }

    .tooltip-date {
      font-weight: 600;
      margin-bottom: 4px;
      color: var(--text-primary);
    }

    .tooltip-value {
      color: var(--text-secondary);
      font-size: 11px;
    }

    .tooltip-titles {
      color: var(--text-secondary);
      font-size: 11px;
      margin-top: 6px;
      padding-top: 6px;
      border-top: 1px solid var(--border-color);
    }

    .modal {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.8);
      z-index: 2000;
      align-items: center;
      justify-content: center;
    }

    .modal.show {
      display: flex;
    }

    .modal-content {
      background: var(--bg-primary);
      border: 1px solid var(--border-color);
      border-radius: 6px;
      padding: 24px;
      width: 460px;
      max-width: 90vw;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.7);
    }

    .modal h2 {
      margin-bottom: 16px;
      font-size: 18px;
      color: var(--text-primary);
    }

    .form-group {
      margin-bottom: 14px;
    }

    .form-label {
      display: block;
      color: var(--text-primary);
      font-size: 13px;
      margin-bottom: 6px;
      font-weight: 600;
    }

    .form-input {
      width: 100%;
      background: var(--bg-secondary);
      border: 1px solid var(--border-color);
      color: var(--text-primary);
      padding: 8px 12px;
      border-radius: 6px;
      font-size: 13px;
      box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.3);
      transition: all 0.2s;
    }

    .form-input:focus {
      outline: none;
      border-color: var(--accent-color);
      box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.3), 0 0 12px rgba(88, 166, 255, 0.15);
    }

    textarea.form-input {
      min-height: 80px;
      resize: vertical;
      font-family: inherit;
    }

    .form-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
    }

    .modal-actions {
      display: flex;
      gap: 8px;
      justify-content: flex-end;
      margin-top: 16px;
    }

    .legend {
      display: flex;
      align-items: center;
      gap: 4px;
      margin-top: 12px;
      font-size: 11px;
      color: var(--text-secondary);
    }

    .legend-item {
      width: 14px;
      height: 14px;
      border-radius: 2px;
    }

    @media (max-width: 768px) {
      .stats-section {
        flex-direction: column;
        align-items: flex-start;
        gap: 16px;
      }
    }

    .entry-list {
      margin-top: 16px;
      padding-top: 16px;
      border-top: 1px solid var(--border-color);
      max-height: 300px;
      overflow-y: auto;
    }

    .entry-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px;
      background: var(--bg-secondary);
      border-radius: 4px;
      margin-bottom: 8px;
      font-size: 13px;
      color: var(--text-primary);
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.3);
      transition: all 0.2s;
    }

    .entry-item:hover {
      background: var(--bg-tertiary);
      box-shadow: 0 3px 10px rgba(0, 0, 0, 0.4);
    }

    .entry-info {
      flex: 1;
    }

    .entry-detail {
      font-size: 12px;
      color: var(--text-secondary);
    }

    .delete-btn {
      background: var(--danger-color);
      border: none;
      color: #ffffff;
      padding: 4px 8px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 12px;
      margin-left: 8px;
      transition: all 0.2s;
      box-shadow: 0 2px 6px rgba(218, 54, 51, 0.3);
    }

    .delete-btn:hover {
      background: var(--danger-hover);
      box-shadow: 0 4px 12px rgba(248, 81, 73, 0.4);
      transform: translateY(-1px);
    }

    .metric-toggle {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      background: rgba(0, 0, 0, 0.3);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 20px;
      padding: 2px 4px;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .metric-toggle:hover {
      background: rgba(0, 0, 0, 0.4);
      border-color: rgba(255, 255, 255, 0.2);
    }

    .metric-option {
      padding: 6px 14px;
      border-radius: 16px;
      font-size: 13px;
      font-weight: 500;
      transition: all 0.3s ease;
      color: #a0a0a0;
      background: transparent;
      border: none;
      cursor: pointer;
    }

    .metric-option.active {
      background: rgba(255, 255, 255, 0.1);
      color: #fcfcfc;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
      transform: scale(1.05);
    }
    
    .goals-section {
      margin-top: 20px;
      padding: 16px;
      background: var(--bg-secondary);
      border-radius: 6px;
      border: 1px solid var(--border-color);
    }
    
    .goal-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 8px 0;
      border-bottom: 1px solid var(--border-color);
    }
    
    .goal-item:last-child {
      border-bottom: none;
    }
    
    .goal-progress {
      width: 100%;
      height: 6px;
      background: var(--bg-tertiary);
      border-radius: 3px;
      overflow: hidden;
      margin-top: 4px;
    }
    
    .goal-progress-bar {
      height: 100%;
      background: var(--accent-color);
      transition: width 0.3s;
    }
    
    .leaderboard-panel {
      background: var(--bg-primary);
      border: 1px solid var(--border-color);
      border-radius: 6px;
      padding: 24px;
      margin-bottom: 20px;
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.4);
    }
    
    .leaderboard-entry {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px;
      background: var(--bg-secondary);
      border-radius: 4px;
      margin-bottom: 8px;
      transition: all 0.2s;
    }
    
    .leaderboard-entry:hover {
      background: var(--bg-tertiary);
      transform: translateX(4px);
    }
    
    .leaderboard-rank {
      font-size: 20px;
      font-weight: 700;
      min-width: 40px;
      color: var(--text-secondary);
    }
    
    .leaderboard-user {
      flex: 1;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    .leaderboard-value {
      font-size: 16px;
      font-weight: 600;
      color: var(--accent-color);
    }
    
    .quick-log-books {
      display: flex;
      gap: 8px;
      margin-bottom: 16px;
      flex-wrap: wrap;
    }
    
    .quick-book-btn {
      background: var(--bg-tertiary);
      border: 1px solid var(--border-color);
      color: var(--text-primary);
      padding: 6px 12px;
      border-radius: 16px;
      cursor: pointer;
      font-size: 12px;
      transition: all 0.2s;
    }
    
    .quick-book-btn:hover {
      background: var(--border-color);
      transform: translateY(-1px);
    }
    
    .quick-book-btn.active {
      background: var(--accent-color);
      color: white;
      border-color: var(--accent-color);
    }
    
    .toggle-section-btn {
      background: var(--bg-tertiary);
      border: 1px solid var(--border-color);
      color: var(--text-primary);
      padding: 8px 16px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 13px;
      transition: all 0.2s;
      margin-right: 8px;
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }
    
    .toggle-section-btn:hover {
      background: var(--border-color);
      transform: translateY(-1px);
    }
    
    .toggle-section-btn.active {
      background: var(--accent-color);
      color: white;
      border-color: var(--accent-color);
    }
    
    .toggle-buttons {
      display: flex;
      gap: 8px;
      margin-top: 16px;
      margin-bottom: 8px;
    }
    
    .theme-selector {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
      margin-top: 12px;
    }
    
    .theme-preview {
      padding: 16px;
      border-radius: 6px;
      cursor: pointer;
      border: 2px solid transparent;
      transition: all 0.2s;
      text-align: center;
      font-size: 13px;
    }
    
    .theme-preview:hover {
      transform: scale(1.05);
    }
    
    .theme-preview.active {
      border-color: var(--accent-color);
      box-shadow: 0 0 16px rgba(35, 134, 54, 0.3);
    }
    
    .theme-preview.default {
      background: linear-gradient(135deg, #0d1117 0%, #161b22 100%);
      color: #c9d1d9;
    }
    
    .theme-preview.nord {
      background: linear-gradient(135deg, #2e3440 0%, #3b4252 100%);
      color: #eceff4;
    }
    
    .theme-preview.tokyo {
      background: linear-gradient(135deg, #1a1b26 0%, #24283b 100%);
      color: #c0caf5;
    }
    
    .theme-preview.dracula {
      background: linear-gradient(135deg, #282a36 0%, #44475a 100%);
      color: #f8f8f2;
    }

    .year-display {
      color: var(--text-primary);
      font-size: 14px;
      font-weight: 600;
      padding: 8px 14px;
      display: inline-flex;
      align-items: center;
    }

    .google-signin-btn {
      padding: 8px 16px;
      display: flex;
      align-items: center;
      gap: 8px;
      background: white;
      color: #3c4043;
      border: 1px solid #dadce0;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 500;
      transition: all 0.2s;
      font-family: 'Roboto', sans-serif;
    }

    .google-signin-btn:hover {
      box-shadow: 0 1px 3px rgba(0,0,0,0.3);
      background: #f8f9fa;
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>Ë™≠Êõ∏</h1>
      <div class="header-actions">
<script>
  window.addEventListener('DOMContentLoaded', () => {
    const el = document.getElementById('authSection');
    if (!el) return;
    el.innerHTML = `
      <button class="google-signin-btn" onclick="promptSignIn()">
        <img src="https://www.gstatic.com/images/branding/product/1x/googleg_32dp.png" alt="" style="width:18px;height:18px;border-radius:2px;">
        Sign in with Google
      </button>
    `;
  });
</script>


        <div id="authSection"></div>
        <button class="icon-btn" onclick="toggleMenu()" title="Settings">‚öôÔ∏è</button>
      </div>
      <input type="file" id="fileInput" style="display: none;" accept=".json" onchange="loadData(event)">
    </header>

    <div class="controls">
      <button class="btn" onclick="changeYear(-1)">‚Üê Prev</button>
      <span class="year-display" id="yearDisplay">2026</span>
      <button class="btn" onclick="changeYear(1)">Next ‚Üí</button>
      
      <div class="metric-toggle">
        <button class="metric-option active" id="minutesBtn" onclick="switchMetric('minutes')">Minutes</button>
        <button class="metric-option" id="charactersBtn" onclick="switchMetric('characters')">Characters</button>
      </div>
    </div>

    <div class="heatmap-panel">
      <div class="calendar-wrapper">
        <div class="day-labels">
          <div class="day-label">Mon</div>
          <div class="day-label"></div>
          <div class="day-label">Wed</div>
          <div class="day-label"></div>
          <div class="day-label">Fri</div>
          <div class="day-label"></div>
          <div class="day-label"></div>
        </div>
        <div id="calendar" class="calendar"></div>
      </div>
      
      <div class="stats-section">
        <div class="stats">
          <div class="stat-line">
            <span>Longest streak:</span>
            <span class="stat-value" id="longestStreak">0 days</span>
          </div>
          <div class="stat-line">
            <span>Streak:</span>
            <span class="stat-value" id="currentStreak">0 days</span>
          </div>
          <div class="stat-line">
            <span>Average:</span>
            <span class="stat-value" id="avgValue">0</span>
          </div>
          <div class="stat-line">
            <span>Total:</span>
            <span class="stat-value" id="totalValue">0</span>
          </div>
        </div>
        
        <button class="log-btn" onclick="openModalForToday()">
          Log today ‚Üí
        </button>
      </div>

      <div class="legend">
        <span>Less</span>
        <div class="legend-item" style="background: var(--level-0); border: 1px solid var(--border-color);"></div>
        <div class="legend-item" style="background: var(--level-1);"></div>
        <div class="legend-item" style="background: var(--level-2);"></div>
        <div class="legend-item" style="background: var(--level-3);"></div>
        <div class="legend-item" style="background: var(--level-4);"></div>
        <span>More</span>
      </div>
    </div>
    
    <div class="toggle-buttons">
      <button class="toggle-section-btn" id="goalsToggle" onclick="toggleGoalsSection()">
        üéØ Goals
      </button>
      <button class="toggle-section-btn" id="leaderboardToggle" onclick="toggleLeaderboardSection()">
        üèÜ Leaderboard
      </button>
    </div>
    
    <div class="goals-section" id="goalsSection" style="display: none;">
      <h3 style="margin-bottom: 12px; font-size: 16px;">Goals</h3>
      <div id="goalsList"></div>
      <button class="btn" onclick="addGoal()" style="margin-top: 12px; width: 100%;">+ Add Goal</button>
    </div>
    
    <div class="leaderboard-panel" id="leaderboardPanel" style="display: none;">
      <h2 style="margin-bottom: 16px;">Leaderboard</h2>
      <div id="leaderboardList"></div>
    </div>
  </div>

  <div class="tooltip" id="tooltip">
    <div class="tooltip-date" id="tooltipDate"></div>
    <div class="tooltip-value" id="tooltipValue"></div>
    <div class="tooltip-titles" id="tooltipTitles"></div>
  </div>

  <div class="modal" id="modal">
    <div class="modal-content">
      <h2>Log reading data</h2>
      <div id="quickLogBooks" class="quick-log-books"></div>
      <div class="form-group">
        <label class="form-label">Date</label>
        <input type="text" class="form-input" id="modalDate" readonly>
      </div>
      <div class="form-row">
        <div class="form-group">
          <label class="form-label">Minutes</label>
          <input type="number" class="form-input" id="modalMinutes" min="0" placeholder="60">
        </div>
        <div class="form-group">
          <label class="form-label">Characters</label>
          <input type="number" class="form-input" id="modalCharacters" min="0" placeholder="10000">
        </div>
      </div>
      <div class="form-group">
        <label class="form-label">Titles (one per line)</label>
        <textarea class="form-input" id="modalTitles" placeholder="Book title 1
Book title 2"></textarea>
      </div>
      <div class="entry-list" id="entryList"></div>
      <div class="modal-actions">
        <button class="btn" onclick="closeModal()">Cancel</button>
        <button class="log-btn" onclick="saveEntry()">Save</button>
      </div>
    </div>
  </div>

  <div class="modal" id="menuModal">
    <div class="modal-content" style="width: 360px;">
      <h2>Settings</h2>
      
      <div style="margin-bottom: 20px;">
        <h3 style="font-size: 14px; margin-bottom: 12px; color: var(--text-secondary);">Theme</h3>
        <div class="theme-selector">
          <div class="theme-preview default" onclick="setTheme('default')">
            <div>GitHub Dark</div>
          </div>
          <div class="theme-preview nord" onclick="setTheme('nord')">
            <div>Nord</div>
          </div>
          <div class="theme-preview tokyo" onclick="setTheme('tokyo')">
            <div>Tokyo Night</div>
          </div>
          <div class="theme-preview dracula" onclick="setTheme('dracula')">
            <div>Dracula</div>
          </div>
        </div>
      </div>
      
      <div style="border-top: 1px solid var(--border-color); padding-top: 16px; margin-top: 16px;">
        <button class="btn" onclick="exportToToggl()" style="width: 100%; margin-bottom: 8px;">‚è±Ô∏è Export to Toggl</button>
        <button class="btn" onclick="downloadData()" style="width: 100%; margin-bottom: 8px;">üíæ Download data</button>
        <button class="btn" onclick="document.getElementById('fileInput').click()" style="width: 100%; margin-bottom: 8px;">üìÇ Load data</button>
        <button class="btn" onclick="wipeAllData()" style="width: 100%; margin-bottom: 8px; background: var(--danger-color); border-color: rgba(255, 0, 0, 0.3);">üóëÔ∏è Wipe all data!</button>
      </div>
      
      <button class="btn" onclick="closeMenu()" style="width: 100%; margin-top: 12px;">Close</button>
    </div>
  </div>
  
  <div class="modal" id="goalModal">
    <div class="modal-content">
      <h2>Set Goal</h2>
      <div class="form-group">
        <label class="form-label">Goal Type</label>
        <select class="form-input" id="goalType">
          <option value="daily_minutes">Daily Minutes</option>
          <option value="daily_characters">Daily Characters</option>
          <option value="weekly_minutes">Weekly Minutes</option>
          <option value="weekly_characters">Weekly Characters</option>
          <option value="streak">Streak (days)</option>
        </select>
      </div>
      <div class="form-group">
        <label class="form-label">Target</label>
        <input type="number" class="form-input" id="goalTarget" min="1" placeholder="60">
      </div>
      <div class="modal-actions">
        <button class="btn" onclick="closeGoalModal()">Cancel</button>
        <button class="log-btn" onclick="saveGoal()">Save Goal</button>
      </div>
    </div>
  </div>

  <script>
    const STORAGE_KEY = 'reading_heatmap_data';
    const GOALS_KEY = 'reading_heatmap_goals';
    const BOOKS_KEY = 'reading_heatmap_books';
    const THEME_KEY = 'reading_heatmap_theme';
    const USER_KEY = 'reading_heatmap_user';
    
    
    let data = [];
    let dailyData = {};
    let goals = [];
    let recentBooks = [];
    let currentUser = null;
    let currentYear = 2026;
    let googleInitialized = false;
    
    window.onload = function() {
      loadTheme();
      loadFromStorage();
      
      // Warn if not running on server
      if (window.location.protocol === 'file:') {
        alert("Warning: Google Sign-In will NOT work if you open this file directly.\nPlease use a local server (e.g., Live Server in VS Code).");
      }
    };


// Fallback prompt-based sign-in if Google OAuth not configured
function promptSignIn() {
  const name = prompt('Enter your name:');
  if (!name) return;
  
  const email = prompt('Enter your email (optional):') || 'user@example.com';
  
  currentUser = {
    id: Date.now().toString(),
    name: name,
    email: email,
    avatar: `https://ui-avatars.com/api/?name=${encodeURIComponent(name)}&background=random&size=128`
  };
  
  localStorage.setItem(USER_KEY, JSON.stringify(currentUser));
  renderUserProfile();
  updateLeaderboard();
  alert('Welcome, ' + name + '! You can now use the leaderboard.');
}

  function signOut() {
    if (confirm('Sign out of your account?')) {
      firebaseSignOut(); // calls Firebase sign-out
    }
  }
    
    function renderUserProfile() {
      const authSection = document.getElementById('authSection');
      if (currentUser) {
        authSection.innerHTML = `
          <div class="user-profile" onclick="signOut()" title="Click to sign out">
            <img src="${currentUser.avatar}" class="user-avatar" alt="${currentUser.name}" onerror="this.src='data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 24 24%22%3E%3Ccircle cx=%2212%22 cy=%2212%22 r=%2212%22 fill=%22%23888%22/%3E%3C/svg%3E'">
            <span class="user-name">${currentUser.name}</span>
          </div>
        `;
      }
    }
    
    function exportToToggl() {
      const togglData = data.map(entry => ({
        description: entry.title || 'Reading',
        start: `${entry.date}T00:00:00Z`,
        duration: entry.minutes * 60,
        tags: ['reading'],
        created_with: 'Reading Heatmap'
      }));
      
      const blob = new Blob([JSON.stringify(togglData, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'reading-toggl-export.json';
      a.click();
      URL.revokeObjectURL(url);
      
      alert('Exported to Toggl format! Import this file to Toggl Track.');
      closeMenu();
    }

    function getAustralianDate() {
      const now = new Date();
      const australiaTime = new Date(now.toLocaleString('en-US', { timeZone: 'Australia/Sydney' }));
      return australiaTime.toISOString().split('T')[0];
    }

    async function loadFromStorage() {
      try {
        const stored = await window.storage.get(STORAGE_KEY);
        if (stored && stored.value) {
          data = JSON.parse(stored.value);
        }
      } catch (error) {
        const stored = localStorage.getItem(STORAGE_KEY);
        if (stored) {
          data = JSON.parse(stored);
        }
      }
      
      try {
        const storedGoals = await window.storage.get(GOALS_KEY);
        if (storedGoals && storedGoals.value) {
          goals = JSON.parse(storedGoals.value);
        }
      } catch (error) {
        const storedGoals = localStorage.getItem(GOALS_KEY);
        if (storedGoals) {
          goals = JSON.parse(storedGoals);
        }
      }
      
      try {
        const storedBooks = await window.storage.get(BOOKS_KEY);
        if (storedBooks && storedBooks.value) {
          recentBooks = JSON.parse(storedBooks.value);
        }
      } catch (error) {
        const storedBooks = localStorage.getItem(BOOKS_KEY);
        if (storedBooks) {
          recentBooks = JSON.parse(storedBooks);
        }
      }
      
      data = data.map(item => ({
        date: String(item.date),
        minutes: Number(item.minutes) || 0,
        characters: Number(item.characters) || 0,
        title: item.title || null
      })).filter(item => /^\d{4}-\d{2}-\d{2}$/.test(item.date));
      
      aggregateData();
      loadYear();
      renderGoals();
    }

    async function saveToStorage() {
      try {
        await window.storage.set(STORAGE_KEY, JSON.stringify(data));
        await window.storage.set(GOALS_KEY, JSON.stringify(goals));
        await window.storage.set(BOOKS_KEY, JSON.stringify(recentBooks));
      } catch (error) {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
        localStorage.setItem(GOALS_KEY, JSON.stringify(goals));
        localStorage.setItem(BOOKS_KEY, JSON.stringify(recentBooks));
      }

      try {
        localStorage.setItem('reading_heatmap_sync_signal', Date.now().toString());
      } catch (e) {}
    }

    function aggregateData() {
      dailyData = {};
      data.forEach(item => {
        if (!dailyData[item.date]) {
          dailyData[item.date] = { minutes: 0, characters: 0, titles: [] };
        }
        dailyData[item.date].minutes += item.minutes;
        dailyData[item.date].characters += item.characters;
        if (item.title && !dailyData[item.date].titles.includes(item.title)) {
          dailyData[item.date].titles.push(item.title);
        }
      });
    }

    function loadYear() {
      document.getElementById('yearDisplay').textContent = currentYear;
      renderHeatmap();
      updateStats();
    }

    function changeYear(delta) {
      currentYear = currentYear + delta;
      loadYear();
    }

    function switchMetric(metric) {
      document.getElementById('minutesBtn').classList.toggle('active', metric === 'minutes');
      document.getElementById('charactersBtn').classList.toggle('active', metric === 'characters');
      
      localStorage.setItem('selectedMetric', metric);
      renderHeatmap();
      updateStats();
    }

    function getSelectedMetric() {
      const stored = localStorage.getItem('selectedMetric');
      return stored || 'minutes';
    }

    function renderHeatmap() {
      const year = currentYear;
      const metric = getSelectedMetric();
      const calendar = document.getElementById('calendar');
      calendar.innerHTML = '';

      const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
      
      const startDate = new Date(year, 0, 1);
      const endDate = new Date(year, 11, 31);
      
      let currentDate = new Date(startDate);
      let currentMonth = -1;
      let weekDiv = null;
      let monthDiv = null;
      
      while (currentDate <= endDate) {
        if (currentDate.getDay() === 0) {
          weekDiv = document.createElement('div');
          weekDiv.className = 'week';
        }
        
        if (!weekDiv) {
          weekDiv = document.createElement('div');
          weekDiv.className = 'week';
        }
        
        const month = currentDate.getMonth();
        if (month !== currentMonth) {
          currentMonth = month;
          monthDiv = document.createElement('div');
          monthDiv.className = 'month';
          
          const label = document.createElement('div');
          label.className = 'month-label';
          label.textContent = months[month];
          monthDiv.appendChild(label);
          
          const weeksContainer = document.createElement('div');
          weeksContainer.className = 'weeks';
          monthDiv.appendChild(weeksContainer);
          
          calendar.appendChild(monthDiv);
        }
        
        const dayDiv = document.createElement('div');
        dayDiv.className = 'day';
        
        const dateStr = currentDate.toISOString().split('T')[0];
        const today = getAustralianDate();
        
        if (dateStr === today) {
          dayDiv.classList.add('today');
        }
        
        const dayData = dailyData[dateStr];
        
        if (dayData) {
          const value = dayData[metric];
          const level = getLevel(value, metric);
          dayDiv.className += ` level-${level}`;
        } else {
          dayDiv.className += ' empty';
        }
        
        dayDiv.dataset.date = dateStr;
        dayDiv.addEventListener('mouseenter', showTooltip);
        dayDiv.addEventListener('mouseleave', hideTooltip);
        dayDiv.addEventListener('click', () => openModal(dateStr));
        
        weekDiv.appendChild(dayDiv);
        
        if (currentDate.getDay() === 6) {
          const weeksContainer = monthDiv.querySelector('.weeks');
          if (weeksContainer) {
            weeksContainer.appendChild(weekDiv);
          }
          weekDiv = null;
        }
        
        currentDate.setDate(currentDate.getDate() + 1);
      }
      
      if (weekDiv && monthDiv) {
        const weeksContainer = monthDiv.querySelector('.weeks');
        if (weeksContainer) {
          weeksContainer.appendChild(weekDiv);
        }
      }
    }

    function getLevel(value, metric) {
      if (value === 0) return 0;
      const thresholds = metric === 'minutes' 
        ? [1, 30, 60, 90] 
        : [1, 3000, 6000, 10000];
      
      for (let i = thresholds.length - 1; i >= 0; i--) {
        if (value >= thresholds[i]) return i + 1;
      }
      return 1;
    }

    function showTooltip(e) {
      const tooltip = document.getElementById('tooltip');
      const dateStr = e.target.dataset.date;
      const dayData = dailyData[dateStr] || { minutes: 0, characters: 0, titles: [] };
      const metric = getSelectedMetric();
      
      const date = new Date(dateStr + 'T00:00:00');
      document.getElementById('tooltipDate').textContent = 
        date.toLocaleDateString('en-US', { weekday: 'short', year: 'numeric', month: 'short', day: 'numeric' });
      
      const value = dayData[metric];
      document.getElementById('tooltipValue').textContent = 
        metric === 'minutes' 
          ? `${value} minutes reading`
          : `${value.toLocaleString()} characters`;
      
      const titlesDiv = document.getElementById('tooltipTitles');
      if (dayData.titles.length > 0) {
        titlesDiv.style.display = 'block';
        titlesDiv.textContent = dayData.titles.join(', ');
      } else {
        titlesDiv.style.display = 'none';
      }
      
      tooltip.className = 'tooltip show';
      
      const rect = e.target.getBoundingClientRect();
      tooltip.style.left = (rect.left + rect.width / 2) + 'px';
      tooltip.style.top = (rect.top - 10) + 'px';
      tooltip.style.transform = 'translate(-50%, -100%)';
    }

    function hideTooltip() {
      document.getElementById('tooltip').className = 'tooltip';
    }

    function updateStats() {
      const year = currentYear;
      const metric = getSelectedMetric();
      
      let longestStreak = 0, currentStreak = 0, streak = 0;
      let total = 0, count = 0;
      
      const startDate = new Date(year, 0, 1);
      const endDate = new Date(year, 11, 31);
      const today = new Date();
      
      for (let d = new Date(startDate); d <= endDate; d.setDate(d.getDate() + 1)) {
        const dateStr = d.toISOString().split('T')[0];
        const dayData = dailyData[dateStr];
        const value = dayData ? dayData[metric] : 0;
        
        total += value;
        count++;
        
        if (value > 0) {
          streak++;
          longestStreak = Math.max(longestStreak, streak);
        } else {
          streak = 0;
        }
      }
      
      streak = 0;
      for (let d = new Date(today); d.getFullYear() === year; d.setDate(d.getDate() - 1)) {
        const dateStr = d.toISOString().split('T')[0];
        const dayData = dailyData[dateStr];
        if (dayData && dayData[metric] > 0) {
          streak++;
        } else {
          break;
        }
      }
      currentStreak = streak;
      
      const avg = count > 0 ? total / count : 0;
      const suffix = metric === 'minutes' ? ' minutes' : ' characters';
      
      document.getElementById('longestStreak').textContent = `${longestStreak} days`;
      document.getElementById('currentStreak').textContent = `${currentStreak} days`;
      document.getElementById('avgValue').textContent = Math.round(avg).toLocaleString() + suffix;
      document.getElementById('totalValue').textContent = Math.round(total).toLocaleString() + suffix;
    }

    function openModal(dateStr) {
      const modal = document.getElementById('modal');
      const dayData = dailyData[dateStr] || { minutes: 0, characters: 0, titles: [] };
      
      document.getElementById('modalDate').value = dateStr;
      document.getElementById('modalMinutes').value = dayData.minutes || '';
      document.getElementById('modalCharacters').value = dayData.characters || '';
      document.getElementById('modalTitles').value = dayData.titles.join('\n');
      
      renderQuickLogBooks();
      renderEntryList(dateStr);
      
      modal.className = 'modal show';
    }
    
    function renderQuickLogBooks() {
      const container = document.getElementById('quickLogBooks');
      if (recentBooks.length === 0) {
        container.innerHTML = '';
        return;
      }
      
      container.innerHTML = '';
      recentBooks.slice(0, 5).forEach(book => {
        const btn = document.createElement('button');
        btn.className = 'quick-book-btn';
        btn.textContent = book;
        btn.onclick = () => {
          const currentTitles = document.getElementById('modalTitles').value;
          if (!currentTitles.includes(book)) {
            document.getElementById('modalTitles').value = currentTitles ? currentTitles + '\n' + book : book;
          }
          btn.classList.add('active');
          setTimeout(() => btn.classList.remove('active'), 300);
        };
        container.appendChild(btn);
      });
    }

    function openModalForToday() {
      const today = getAustralianDate();
      openModal(today);
    }

    function closeModal() {
      document.getElementById('modal').className = 'modal';
    }

    function renderEntryList(dateStr) {
      const entryList = document.getElementById('entryList');
      const dateEntries = data.filter(item => item.date === dateStr);
      
      if (dateEntries.length === 0) {
        entryList.innerHTML = '';
        return;
      }
      
      entryList.innerHTML = '<div style="color: var(--text-secondary); font-size: 12px; margin-bottom: 8px;">Entries for this date:</div>';
      
      dateEntries.forEach((entry, index) => {
        const entryDiv = document.createElement('div');
        entryDiv.className = 'entry-item';
        
        let content = '';
        if (entry.title) {
          content = `<strong>${entry.title}</strong>`;
          if (entry.minutes > 0 || entry.characters > 0) {
            content += `<br><span class="entry-detail">${entry.minutes} min, ${entry.characters.toLocaleString()} chars</span>`;
          }
        } else {
          content = `<strong>${entry.minutes} min</strong><br><span class="entry-detail">${entry.characters.toLocaleString()} characters</span>`;
        }
        
        entryDiv.innerHTML = `
          <div class="entry-info">${content}</div>
          <button class="delete-btn" onclick="deleteEntry('${dateStr}', ${index})">Delete</button>
        `;
        
        entryList.appendChild(entryDiv);
      });
    }

    function deleteEntry(dateStr, index) {
      const dateEntries = data.filter(item => item.date === dateStr);
      if (dateEntries[index]) {
        const entryToDelete = dateEntries[index];
        data = data.filter(item => !(item.date === dateStr && 
          item.minutes === entryToDelete.minutes && 
          item.characters === entryToDelete.characters && 
          item.title === entryToDelete.title));
        
        saveToStorage().then(() => {
          aggregateData();
          renderEntryList(dateStr);
          loadYear();
        });
      }
    }

    async function saveEntry() {
      const dateStr = document.getElementById('modalDate').value;
      const minutes = parseInt(document.getElementById('modalMinutes').value) || 0;
      const characters = parseInt(document.getElementById('modalCharacters').value) || 0;
      const titles = document.getElementById('modalTitles').value
        .split('\n')
        .map(t => t.trim())
        .filter(Boolean);
      
      titles.forEach(title => {
        if (!recentBooks.includes(title)) {
          recentBooks.unshift(title);
          recentBooks = recentBooks.slice(0, 10);
        }
      });
      
      data = data.filter(item => item.date !== dateStr);
      
      if (titles.length > 0) {
        data.push({ date: dateStr, minutes, characters, title: titles[0] });
        titles.slice(1).forEach(title => {
          data.push({ date: dateStr, minutes: 0, characters: 0, title });
        });
      } else {
        data.push({ date: dateStr, minutes, characters, title: null });
      }
      
      await saveToStorage();
      aggregateData();
      loadYear();
      renderGoals();
      updateLeaderboard();
      closeModal();
    }

    function downloadData() {
      const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'reading-heatmap-data.json';
      a.click();
      URL.revokeObjectURL(url);
      closeMenu();
    }

    function loadData(event) {
      const file = event.target.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = function(e) {
        try {
          const importedData = JSON.parse(e.target.result);
          
          if (!Array.isArray(importedData)) {
            alert('Invalid data format. Expected an array.');
            return;
          }
          
          if (importedData.length > 0 && confirm('Replace existing data with imported data?')) {
            data = importedData;
          } else if (importedData.length > 0) {
            data = data.concat(importedData);
          }
          
          saveToStorage().then(() => {
            aggregateData();
            loadYear();
            alert('Data loaded successfully!');
          });
        } catch (error) {
          alert('Error reading file: ' + error.message);
        }
      };
      
      reader.readAsText(file);
      event.target.value = '';
    }

    function toggleMenu() {
      const modal = document.getElementById('menuModal');
      modal.className = 'modal show';
      updateThemeSelection();
    }

    function closeMenu() {
      document.getElementById('menuModal').className = 'modal';
    }

    function wipeAllData() {
      if (confirm('Are you sure? This will permanently delete all data. This action cannot be undone.')) {
        if (confirm('Really delete ALL data? Click OK to confirm.')) {
          data = [];
          dailyData = {};
          goals = [];
          recentBooks = [];
          saveToStorage().then(() => {
            loadYear();
            renderGoals();
            closeMenu();
            alert('All data has been wiped.');
          });
        }
      }
    }

    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape' || e.key === 'Esc') {
        try { hideTooltip(); } catch (err) {}
        try { closeModal(); } catch (err) {}
        try { closeMenu(); } catch (err) {}
        try { closeGoalModal(); } catch (err) {}

        try {
          const active = document.activeElement;
          if (active && (active.tagName === 'INPUT' || active.tagName === 'TEXTAREA' || active.tagName === 'BUTTON' || active.isContentEditable)) {
            active.blur();
          }
        } catch (err) {}
      }
    });

    document.getElementById('modal').addEventListener('click', (e) => {
      if (e.target.id === 'modal') closeModal();
    });
    document.getElementById('menuModal').addEventListener('click', (e) => {
      if (e.target.id === 'menuModal') closeMenu();
    });
    
    function loadTheme() {
      const theme = localStorage.getItem(THEME_KEY) || 'default';
      setTheme(theme, false);
    }
    
    function setTheme(theme, save = true) {
      document.body.className = theme === 'default' ? '' : `theme-${theme}`;
      if (save) {
        localStorage.setItem(THEME_KEY, theme);
        updateThemeSelection();
      }
    }
    
    function updateThemeSelection() {
      const currentTheme = localStorage.getItem(THEME_KEY) || 'default';
      document.querySelectorAll('.theme-preview').forEach(el => {
        const themeClass = el.className.split(' ').find(c => c !== 'theme-preview' && c !== 'active');
        if (themeClass === currentTheme) {
          el.classList.add('active');
        } else {
          el.classList.remove('active');
        }
      });
    }
    
    function toggleGoalsSection() {
      const section = document.getElementById('goalsSection');
      const btn = document.getElementById('goalsToggle');
      const isVisible = section.style.display !== 'none';
      
      section.style.display = isVisible ? 'none' : 'block';
      btn.classList.toggle('active', !isVisible);
    }
    
    function addGoal() {
      document.getElementById('goalModal').className = 'modal show';
    }
    
    function closeGoalModal() {
      document.getElementById('goalModal').className = 'modal';
    }
    
    async function saveGoal() {
      const type = document.getElementById('goalType').value;
      const target = parseInt(document.getElementById('goalTarget').value);
      
      if (!target || target <= 0) {
        alert('Please enter a valid target');
        return;
      }
      
      goals.push({ type, target, id: Date.now() });
      await saveToStorage();
      renderGoals();
      closeGoalModal();
      
      document.getElementById('goalTarget').value = '';
    }
    
    function renderGoals() {
      const container = document.getElementById('goalsList');
      if (goals.length === 0) {
        container.innerHTML = '<div style="color: var(--text-secondary); font-size: 13px;">No goals set yet</div>';
        return;
      }
      
      container.innerHTML = '';
      goals.forEach(goal => {
        const progress = calculateGoalProgress(goal);
        const goalDiv = document.createElement('div');
        goalDiv.className = 'goal-item';
        
        const typeText = {
          daily_minutes: 'Daily Minutes',
          daily_characters: 'Daily Characters',
          weekly_minutes: 'Weekly Minutes',
          weekly_characters: 'Weekly Characters',
          streak: 'Streak Days'
        }[goal.type];
        
        goalDiv.innerHTML = `
          <div style="flex: 1;">
            <div style="display: flex; justify-content: space-between; margin-bottom: 4px;">
              <span>${typeText}: ${goal.target}</span>
              <span style="color: var(--accent-color); font-weight: 600;">${progress.current} / ${goal.target}</span>
            </div>
            <div class="goal-progress">
              <div class="goal-progress-bar" style="width: ${Math.min(100, (progress.current / goal.target) * 100)}%"></div>
            </div>
          </div>
          <button class="delete-btn" onclick="deleteGoal(${goal.id})">Delete</button>
        `;
        
        container.appendChild(goalDiv);
      });
    }
    
    function calculateGoalProgress(goal) {
      const today = getAustralianDate();
      const metric = goal.type.includes('minutes') ? 'minutes' : goal.type.includes('characters') ? 'characters' : 'streak';
      
      if (goal.type.startsWith('daily')) {
        const dayData = dailyData[today];
        return { current: dayData ? dayData[metric] : 0, target: goal.target };
      } else if (goal.type.startsWith('weekly')) {
        let total = 0;
        const now = new Date(today);
        for (let i = 0; i < 7; i++) {
          const d = new Date(now);
          d.setDate(d.getDate() - i);
          const dateStr = d.toISOString().split('T')[0];
          const dayData = dailyData[dateStr];
          if (dayData) total += dayData[metric];
        }
        return { current: total, target: goal.target };
      } else if (goal.type === 'streak') {
        let streak = 0;
        const now = new Date(today);
        for (let i = 0; i < 365; i++) {
          const d = new Date(now);
          d.setDate(d.getDate() - i);
          const dateStr = d.toISOString().split('T')[0];
          const dayData = dailyData[dateStr];
          if (dayData && (dayData.minutes > 0 || dayData.characters > 0)) {
            streak++;
          } else {
            break;
          }
        }
        return { current: streak, target: goal.target };
      }
      return { current: 0, target: goal.target };
    }
    
    async function deleteGoal(id) {
      goals = goals.filter(g => g.id !== id);
      await saveToStorage();
      renderGoals();
    }
    
    function toggleLeaderboardSection() {
      const panel = document.getElementById('leaderboardPanel');
      const btn = document.getElementById('leaderboardToggle');
      const isVisible = panel.style.display !== 'none';
      
      panel.style.display = isVisible ? 'none' : 'block';
      btn.classList.toggle('active', !isVisible);
      
      if (!isVisible) {
        loadLeaderboard();
      }
    }
    
    async function loadLeaderboard() {
      const container = document.getElementById('leaderboardList');
      
      if (!currentUser) {
        container.innerHTML = '<div style="color: var(--text-secondary); text-align: center; padding: 20px;">Sign in to view the leaderboard and compete with others!</div>';
        return;
      }
      
      try {
        const keys = await window.storage.list('leaderboard:', true);
        if (!keys || !keys.keys || keys.keys.length === 0) {
          container.innerHTML = '<div style="color: var(--text-secondary); text-align: center; padding: 20px;">No leaderboard data yet. Be the first to log!</div>';
          return;
        }
        
        const leaderboardData = [];
        for (const key of keys.keys) {
          try {
            const entry = await window.storage.get(key, true);
            if (entry && entry.value) {
              leaderboardData.push(JSON.parse(entry.value));
            }
          } catch (e) {
            console.error('Failed to load leaderboard entry:', e);
          }
        }
        
        leaderboardData.sort((a, b) => b.totalMinutes - a.totalMinutes);
        
        container.innerHTML = '';
        leaderboardData.slice(0, 10).forEach((entry, index) => {
          const rankDiv = document.createElement('div');
          rankDiv.className = 'leaderboard-entry';
          
          const medal = index === 0 ? 'ü•á' : index === 1 ? 'ü•à' : index === 2 ? 'ü•â' : `#${index + 1}`;
          
          rankDiv.innerHTML = `
            <div class="leaderboard-rank">${medal}</div>
            <div class="leaderboard-user">
              <img src="${entry.avatar || 'data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 24 24%22%3E%3Ccircle cx=%2212%22 cy=%2212%22 r=%2212%22 fill=%22%23888%22/%3E%3C/svg%3E'}" class="user-avatar" alt="${entry.name}" style="width: 32px; height: 32px;">
              <span>${entry.name}</span>
            </div>
            <div class="leaderboard-value">${entry.totalMinutes.toLocaleString()} min</div>
          `;
          
          container.appendChild(rankDiv);
        });
        
      } catch (error) {
        container.innerHTML = '<div style="color: var(--text-secondary); text-align: center; padding: 20px;">Failed to load leaderboard data.</div>';
        console.error('Leaderboard error:', error);
      }
    }
    
    async function updateLeaderboard() {
      if (!currentUser) return;
      
      let totalMinutes = 0;
      Object.values(dailyData).forEach(day => {
        totalMinutes += day.minutes;
      });
      
      const leaderboardEntry = {
        userId: currentUser.id,
        name: currentUser.name,
        avatar: currentUser.avatar,
        totalMinutes: totalMinutes,
        lastUpdated: new Date().toISOString()
      };
      
      try {
        await window.storage.set(`leaderboard:${currentUser.id}`, JSON.stringify(leaderboardEntry), true);
      } catch (error) {
        console.error('Failed to update leaderboard:', error);
      }
    }

    window.addEventListener('storage', (e) => {
      if (!e) return;
      if (e.key === STORAGE_KEY || e.key === 'reading_heatmap_sync_signal') {
        loadFromStorage();
      }
    });
    
  </script>
  <!-- Firebase integration: Auth (Google) + Firestore -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.0/firebase-app.js";
  import { getAuth, GoogleAuthProvider, signInWithPopup, signOut } from "https://www.gstatic.com/firebasejs/11.0.0/firebase-auth.js";
  import { getFirestore, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/11.0.0/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyAmGPOSR03tCzi3cftfaP6JTBSk30JUgIwAIzaSyAmGPOSR03tCzi3cftfaP6JTBSk30JUgIw",
    authDomain: "timetracker-79479.firebaseapp.com",
    projectId: "timetracker-79479",
    storageBucket: "timetracker-79479.appspot.com",
    appId: "1:374798694344:web:77b1e15a27fc03ce76b2fd"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  async function firebaseSignIn() {
    const provider = new GoogleAuthProvider();
    provider.setCustomParameters({ prompt: 'select_account' });
    const result = await signInWithPopup(auth, provider);
    const user = result.user;

    window.currentUser = {
      id: user.uid,
      name: user.displayName || 'User',
      email: user.email || '',
      avatar: user.photoURL || `https://ui-avatars.com/api/?name=${encodeURIComponent(user.displayName || 'User')}&background=random&size=128`
    };
    window.renderUserProfile?.();
    await loadCloudState(user.uid);
    window.aggregateData?.();
    window.loadYear?.();
    window.renderGoals?.();
    window.updateLeaderboard?.();
  }

  async function firebaseSignOut() {
    await signOut(auth);
    window.currentUser = null;
    window.renderUserProfile?.();
    // Optional: clear local in-memory state
  }

  async function loadCloudState(uid) {
    const ref = doc(db, 'users', uid, 'reading', 'heatmap');
    const snap = await getDoc(ref);
    if (snap.exists()) {
      const cloud = snap.data();
      window.data = Array.isArray(cloud.data) ? cloud.data : [];
      window.goals = Array.isArray(cloud.goals) ? cloud.goals : [];
      window.recentBooks = Array.isArray(cloud.recentBooks) ? cloud.recentBooks : [];
    } else {
      window.data = [];
      window.goals = [];
      window.recentBooks = [];
      await setDoc(ref, { data: [], goals: [], recentBooks: [], lastUpdated: new Date().toISOString() });
    }
  }

  async function saveCloudState() {
    if (!window.currentUser) return;
    const ref = doc(db, 'users', window.currentUser.id, 'reading', 'heatmap');
    await setDoc(ref, {
      data: window.data,
      goals: window.goals,
      recentBooks: window.recentBooks,
      lastUpdated: new Date().toISOString()
    }, { merge: true });
  }

  // Hook cloud saves after local mutations
  if (typeof window.saveEntry === 'function') {
    const originalSaveEntry = window.saveEntry;
    window.saveEntry = async function() {
      const p = originalSaveEntry();
      await p;
      await saveCloudState();
    };
  }
  if (typeof window.deleteEntry === 'function') {
    const originalDeleteEntry = window.deleteEntry;
    window.deleteEntry = async function(dateStr, index) {
      const p = originalDeleteEntry(dateStr, index);
      await p;
      await saveCloudState();
    };
  }
  if (typeof window.saveGoal === 'function') {
    const originalSaveGoal = window.saveGoal;
    window.saveGoal = async function() {
      const p = originalSaveGoal();
      await p;
      await saveCloudState();
    };
  }
  if (typeof window.wipeAllData === 'function') {
    const originalWipeAllData = window.wipeAllData;
    window.wipeAllData = async function() {
      const p = originalWipeAllData();
      await p;
      await saveCloudState();
    };
  }

  // Map UI hooks
  window.promptSignIn = firebaseSignIn;
  window.firebaseSignOut = firebaseSignOut;
</script>


</body>
</html>