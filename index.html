<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Reading Heatmap</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://fonts.googleapis.com/css2?family=Klee+One:wght@400;600&display=swap" rel="stylesheet">

  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    
    :root {
      --bg-primary: #0d1117;
      --bg-secondary: #161b22;
      --bg-tertiary: #21262d;
      --border-color: #30363d;
      --text-primary: #c9d1d9;
      --text-secondary: #8b949e;
      --accent-color: #238636;
      --accent-hover: #2ea043;
      --danger-color: #da3633;
      --danger-hover: #f85149;
      --level-0: #161b22;
      --level-1: #0e4429;
      --level-2: #006d32;
      --level-3: #26a641;
      --level-4: #39d353;
    }
    
    body.theme-nord {
  --bg-primary: #2e3440;
  --bg-secondary: #3b4252;
  --bg-tertiary: #434c5e;
  --border-color: #4c566a;
  --text-primary: #eceff4;
  --text-secondary: #d8dee9;
  --accent-color: #88c0d0;
  --accent-hover: #8fbcbb;
  --danger-color: #bf616a;
  --danger-hover: #d08770;
  --level-0: #3b4252;
  --level-1: #4d6780;
  --level-2: #5e81ac;
  --level-3: #7a99c4;
  --level-4: #96b1dc;
}

body.theme-tokyo {
  --bg-primary: #1a1b26;
  --bg-secondary: #16161e;
  --bg-tertiary: #24283b;
  --border-color: #414868;
  --text-primary: #a9b1d6;
  --text-secondary: #565f89;
  --accent-color: #7aa2f7;
  --accent-hover: #7dcfff;
  --danger-color: #f7768e;
  --danger-hover: #ff9e64;
  --level-0: #24283b;
  --level-1: #3d5a8f;
  --level-2: #5678c4;
  --level-3: #7aa2f7;
  --level-4: #a4c0ff;
}

body.theme-dracula {
  --bg-primary: #282a36;
  --bg-secondary: #21222c;
  --bg-tertiary: #343746;
  --border-color: #44475a;
  --text-primary: #f8f8f2;
  --text-secondary: #6272a4;
  --accent-color: #50fa7b;
  --accent-hover: #5af78e;
  --danger-color: #ff5555;
  --danger-hover: #ff6e6e;
  --level-0: #44475a;
  --level-1: #3d9970;
  --level-2: #42c285;
  --level-3: #50fa7b;
  --level-4: #7dffa0;
}

body.theme-everforest {
  --bg-primary: #fdf6e3;
  --bg-secondary: #f4f0d9;
  --bg-tertiary: #efebd4;
  --border-color: #e0dcc7;
  --text-primary: #5c6a72;
  --text-secondary: #939f91;
  --accent-color: #8da101;
  --accent-hover: #a7b901;
  --danger-color: #f85552;
  --danger-hover: #e66868;
  --level-0: #f4f0d9;
  --level-1: #b9ca4a;
  --level-2: #a7c080;
  --level-3: #8da101;
  --level-4: #6f8800;
}

body.theme-onedark {
  --bg-primary: #282c34;
  --bg-secondary: #21252b;
  --bg-tertiary: #2c313c;
  --border-color: #3e4451;
  --text-primary: #abb2bf;
  --text-secondary: #5c6370;
  --accent-color: #98c379;
  --accent-hover: #b5cea8;
  --danger-color: #e06c75;
  --danger-hover: #be5046;
  --level-0: #21252b;
  --level-1: #5a8a5e;
  --level-2: #74a774;
  --level-3: #98c379;
  --level-4: #b5d8a0;
}

body.theme-nord-light {
  --bg-primary: #eceff4;
  --bg-secondary: #e5e9f0;
  --bg-tertiary: #d8dee9;
  --border-color: #c2c9d6;
  --text-primary: #2e3440;
  --text-secondary: #4c566a;
  --accent-color: #5e81ac;
  --accent-hover: #81a1c1;
  --danger-color: #bf616a;
  --danger-hover: #d08770;
  --level-0: #e5e9f0;
  --level-1: #a8c5db;
  --level-2: #81a1c1;
  --level-3: #5e81ac;
  --level-4: #4c6a95;
}

body.theme-phoenix {
  --bg-primary: #170f1e;
  --bg-secondary: #1c1521;
  --bg-tertiary: #2b2032;
  --border-color: #3d2f47;
  --text-primary: #f5c2e7;
  --text-secondary: #988ba2;
  --accent-color: #cba6f7;
  --accent-hover: #d4b4f8;
  --danger-color: #f38ba8;
  --danger-hover: #f5a7bc;
  --level-0: #1c1521;
  --level-1: #8b6ba8;
  --level-2: #a888c7;
  --level-3: #cba6f7;
  --level-4: #e0c8ff;
}
body.theme-phoenix {
  --bg-primary: #170f1e;
  --bg-secondary: #1c1521;
  --bg-tertiary: #2b2032;
  --border-color: #3d2f47;
  --text-primary: #f5c2e7;
  --text-secondary: #988ba2;
  --accent-color: #cba6f7;
  --accent-hover: #d4b4f8;
  --danger-color: #f38ba8;
  --danger-hover: #f5a7bc;
  --level-0: #1c1521;
  --level-1: #8b6ba8;
  --level-2: #a888c7;
  --level-3: #cba6f7;
  --level-4: #e0c8ff;
}

body.theme-ereader {
  --bg-primary: #ffffff;
  --bg-secondary: #f5f5f5;
  --bg-tertiary: #e8e8e8;
  --border-color: #d0d0d0;
  --text-primary: #000000;
  --text-secondary: #666666;
  --accent-color: #333333;
  --accent-hover: #000000;
  --danger-color: #555555;
  --danger-hover: #333333;
  --level-0: #ffffff;
  --level-1: #d0d0d0;
  --level-2: #a0a0a0;
  --level-3: #666666;
  --level-4: #333333;
}

/* E-reader specific optimizations */
body.theme-ereader {
  font-size: 16px;
  line-height: 1.6;
}

body.theme-ereader .container {
  max-width: 100%;
  padding: 20px 15px;
}

body.theme-ereader h1 {
  font-size: 22px;
  color: #000000;
}

body.theme-ereader .day {
  width: 16px;
  height: 16px;
  border: 1px solid #d0d0d0;
}

body.theme-ereader .btn,
body.theme-ereader .log-btn,
body.theme-ereader select,
body.theme-ereader input {
  border: 2px solid #333333;
  box-shadow: none;
}

body.theme-ereader .heatmap-panel,
body.theme-ereader .leaderboard-panel,
body.theme-ereader .goals-section {
  box-shadow: none;
  border: 2px solid #d0d0d0;
}

body.theme-ereader .icon-btn:hover,
body.theme-ereader .btn:hover {
  background: #e8e8e8;
  box-shadow: none;
}

body.theme-ereader .log-btn {
  background: #333333;
  color: #ffffff;
  box-shadow: none;
}

body.theme-ereader .log-btn:hover {
  background: #000000;
  box-shadow: none;
  transform: none;
}

body.theme-ereader .day:hover {
  outline: 2px solid #000000;
  box-shadow: none;
  transform: scale(1.1);
}

body.theme-ereader .modal-content {
  box-shadow: none;
  border: 3px solid #333333;
}

body.theme-ereader .entry-item,
body.theme-ereader .leaderboard-entry {
  box-shadow: none;
  border: 1px solid #d0d0d0;
}

/* Optimize for 7-inch screen (typical resolution: 1264x1680 or 1072x1448) */
@media screen and (max-width: 1280px) and (max-height: 1700px) {
  body.theme-ereader {
    font-size: 15px;
  }
  
  body.theme-ereader .container {
    max-width: 100%;
    padding: 15px 10px;
  }
  
  body.theme-ereader h1 {
    font-size: 20px;
  }
  
  body.theme-ereader .controls {
    flex-wrap: wrap;
    gap: 8px;
  }
  
  body.theme-ereader .day {
    width: 14px;
    height: 14px;
  }
  
  body.theme-ereader .btn,
  body.theme-ereader .log-btn {
    padding: 8px 12px;
    font-size: 14px;
  }
  
  body.theme-ereader .metric-option {
    padding: 6px 10px;
    font-size: 13px;
  }
}
    
    body {
      font-family: "Klee One", cursive;
      background: var(--bg-primary);
      color: var(--text-primary);
      padding: 40px 20px;
      min-height: 100vh;
      overflow-x: hidden;
    }
    
    html {
      overflow-x: hidden;
      background: var(--bg-primary);
    }

    .container {
      max-width: 1100px;
      margin: 0 auto;
    }

    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 32px;
    }

    h1 {
      font-size: 24px;
      font-weight: 700;
      color: #ffffff;
    }

    .header-actions {
      display: flex;
      gap: 8px;
      align-items: center;
    }

    .icon-btn {
      background: transparent;
      border: none;
      color: var(--text-secondary);
      padding: 8px;
      cursor: pointer;
      border-radius: 6px;
      transition: all 0.2s;
      font-size: 18px;
    }

    .icon-btn:hover {
      background: var(--bg-tertiary);
      color: var(--text-primary);
    }
    
    .user-profile {
      display: flex;
      align-items: center;
      gap: 10px;
      background: var(--bg-tertiary);
      padding: 6px 12px;
      border-radius: 20px;
      cursor: pointer;
    }
    
    .user-profile:hover {
      background: var(--border-color);
    }
    
    .user-avatar {
      width: 28px;
      height: 28px;
      border-radius: 50%;
    }
    
    .user-name {
      font-size: 14px;
      color: var(--text-primary);
    }

    .controls {
      display: flex;
      gap: 12px;
      margin-bottom: 24px;
      align-items: center;
    }

    .btn {
      background: var(--bg-tertiary);
      border: 1px solid var(--border-color);
      color: var(--text-primary);
      padding: 8px 14px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 13px;
      transition: all 0.2s;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
    }

    .btn:hover {
      background: var(--border-color);
      border-color: var(--text-secondary);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.4);
    }

    select, input[type="number"] {
      background: var(--bg-secondary);
      border: 1px solid var(--border-color);
      color: var(--text-primary);
      padding: 8px 12px;
      border-radius: 6px;
      font-size: 13px;
      box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.3);
      transition: all 0.2s;
    }

    .heatmap-panel {
      background: var(--bg-primary);
      border: 1px solid var(--border-color);
      border-radius: 6px;
      padding: 24px;
      margin-bottom: 20px;
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.4);
    }

    .day-labels {
      display: flex;
      flex-direction: column;
      gap: 5px;
      font-size: 12px;
      color: var(--text-secondary);
      margin-right: 8px;
      padding-top: 24px;
    }

    .day-label {
      height: 14px;
      line-height: 14px;
      display: flex;
      align-items: center;
    }
    
    .day-label:nth-child(2),
    .day-label:nth-child(4),
    .day-label:nth-child(6),
    .day-label:nth-child(7) {
      visibility: hidden;
    }

    .calendar-wrapper {
      display: flex;
      overflow-x: auto;
      padding-bottom: 4px;
      scrollbar-width: none;
    }

    .calendar-wrapper::-webkit-scrollbar {
      display: none;
    }

    .calendar {
      display: flex;
      gap: 5px;
    }

    .month {
      display: flex;
      flex-direction: column;
    }

    .month-label {
      font-size: 11px;
      font-weight: 400;
      color: var(--text-secondary);
      margin-bottom: 4px;
      height: 16px;
    }

    .weeks {
      display: flex;
      gap: 5px;
    }

    .week {
      display: flex;
      flex-direction: column;
      gap: 5px;
    }

    .week.partial-start {
      padding-top: calc(var(--offset, 0) * (14px + 6px));
    }

    .day {
      width: 14px;
      height: 14px;
      border-radius: 2px;
      cursor: pointer;
      transition: all 0.15s;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.4);
    }

    .day.empty {
      background: var(--level-0);
      border: 1px solid var(--border-color);
    }

    .day.level-1 { background: var(--level-1); }
    .day.level-2 { background: var(--level-2); }
    .day.level-3 { background: var(--level-3); }
    .day.level-4 { background: var(--level-4); }

    .day:hover {
      outline: 1.5px solid rgba(255, 255, 255, 0.7);
      outline-offset: 1px;
      transform: scale(1.2);
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.5);
    }

    .day.today {
      outline: 2px solid var(--accent-color);
      outline-offset: 1px;
    }

    .stats-section {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: 16px;
    }

    .stats {
      display: flex;
      flex-direction: column;
      gap: 4px;
      font-size: 13px;
      color: var(--text-secondary);
    }
    
    .stat-line {
      display: flex;
      gap: 4px;
    }

    .stat-value {
      color: var(--text-primary);
      font-weight: 600;
    }

    .log-btn {
      background: var(--accent-color);
      border: none;
      color: #ffffff;
      padding: 10px 20px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 13px;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 6px;
      transition: all 0.2s;
      box-shadow: 0 4px 12px rgba(35, 134, 54, 0.3);
    }

    .log-btn:hover {
      background: var(--accent-hover);
      box-shadow: 0 6px 16px rgba(46, 160, 67, 0.4);
      transform: translateY(-2px);
    }

    .tooltip {
      position: fixed;
      background: var(--bg-tertiary);
      border: 1px solid var(--border-color);
      border-radius: 6px;
      padding: 10px 12px;
      font-size: 12px;
      pointer-events: none;
      z-index: 1000;
      display: none;
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.6);
      max-width: 250px;
    }

    .tooltip.show {
      display: block;
    }

    .tooltip-date {
      font-weight: 600;
      margin-bottom: 4px;
      color: var(--text-primary);
    }

    .tooltip-value {
      color: var(--text-secondary);
      font-size: 11px;
    }

    .tooltip-titles {
      color: var(--text-secondary);
      font-size: 11px;
      margin-top: 6px;
      padding-top: 6px;
      border-top: 1px solid var(--border-color);
    }

    .modal {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.8);
      z-index: 2000;
      align-items: center;
      justify-content: center;
    }

    .modal.show {
      display: flex;
    }

    .modal-content {
      background: var(--bg-primary);
      border: 1px solid var(--border-color);
      border-radius: 6px;
      padding: 24px;
      width: 460px;
      max-width: 90vw;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.7);
    }

    .modal h2 {
      margin-bottom: 16px;
      font-size: 18px;
      color: var(--text-primary);
    }

    .form-group {
      margin-bottom: 14px;
    }

    .form-label {
      display: block;
      color: var(--text-primary);
      font-size: 13px;
      margin-bottom: 6px;
      font-weight: 600;
    }

    .form-input {
      width: 100%;
      background: var(--bg-secondary);
      border: 1px solid var(--border-color);
      color: var(--text-primary);
      padding: 8px 12px;
      border-radius: 6px;
      font-size: 13px;
      box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.3);
      transition: all 0.2s;
    }

    .form-input:focus {
      outline: none;
      border-color: var(--accent-color);
      box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.3), 0 0 12px rgba(88, 166, 255, 0.15);
    }

    textarea.form-input {
      min-height: 80px;
      resize: vertical;
      font-family: inherit;
    }

    .form-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
    }

    .modal-actions {
      display: flex;
      gap: 8px;
      justify-content: flex-end;
      margin-top: 16px;
    }

    .legend {
      display: flex;
      align-items: center;
      gap: 4px;
      margin-top: 12px;
      font-size: 11px;
      color: var(--text-secondary);
    }

    .legend-item {
      width: 14px;
      height: 14px;
      border-radius: 2px;
    }

    @media (max-width: 768px) {
      .stats-section {
        flex-direction: column;
        align-items: flex-start;
        gap: 16px;
      }
    }

    .entry-list {
      margin-top: 16px;
      padding-top: 16px;
      border-top: 1px solid var(--border-color);
      max-height: 300px;
      overflow-y: auto;
    }

    .entry-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px;
      background: var(--bg-secondary);
      border-radius: 4px;
      margin-bottom: 8px;
      font-size: 13px;
      color: var(--text-primary);
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.3);
      transition: all 0.2s;
    }

    .entry-item:hover {
      background: var(--bg-tertiary);
      box-shadow: 0 3px 10px rgba(0, 0, 0, 0.4);
    }

    .entry-info {
      flex: 1;
    }

    .entry-detail {
      font-size: 12px;
      color: var(--text-secondary);
    }

    .delete-btn {
      background: var(--danger-color);
      border: none;
      color: #ffffff;
      padding: 4px 8px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 12px;
      margin-left: 8px;
      transition: all 0.2s;
      box-shadow: 0 2px 6px rgba(218, 54, 51, 0.3);
    }

    .delete-btn:hover {
      background: var(--danger-hover);
      box-shadow: 0 4px 12px rgba(248, 81, 73, 0.4);
      transform: translateY(-1px);
    }

    .metric-toggle {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      background: rgba(0, 0, 0, 0.3);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 20px;
      padding: 2px 4px;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .metric-toggle:hover {
      background: rgba(0, 0, 0, 0.4);
      border-color: rgba(255, 255, 255, 0.2);
    }

    .metric-option {
      padding: 6px 14px;
      border-radius: 16px;
      font-size: 13px;
      font-weight: 500;
      transition: all 0.3s ease;
      color: #a0a0a0;
      background: transparent;
      border: none;
      cursor: pointer;
    }

    .metric-option.active {
      background: rgba(255, 255, 255, 0.1);
      color: #fcfcfc;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
      transform: scale(1.05);
    }
    
    .goals-section {
      margin-top: 20px;
      padding: 16px;
      background: var(--bg-secondary);
      border-radius: 6px;
      border: 1px solid var(--border-color);
    }
    
    .goal-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 8px 0;
      border-bottom: 1px solid var(--border-color);
    }
    
    .goal-item:last-child {
      border-bottom: none;
    }
    
    .goal-progress {
      width: 100%;
      height: 6px;
      background: var(--bg-tertiary);
      border-radius: 3px;
      overflow: hidden;
      margin-top: 4px;
    }
    
    .goal-progress-bar {
      height: 100%;
      background: var(--accent-color);
      transition: width 0.3s;
    }
    
    .leaderboard-panel {
      background: var(--bg-primary);
      border: 1px solid var(--border-color);
      border-radius: 6px;
      padding: 24px;
      margin-top: 32px;
      margin-bottom: 20px;
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.4);
    }

    .leaderboard-entry {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px;
      background: var(--bg-secondary);
      border-radius: 4px;
      margin-bottom: 8px;
      transition: all 0.2s;
    }
    
    .leaderboard-entry:hover {
      background: var(--bg-tertiary);
      transform: translateX(4px);
    }
    
    .leaderboard-rank {
      font-size: 20px;
      font-weight: 700;
      min-width: 40px;
      color: var(--text-secondary);
    }
    
    .leaderboard-user {
      flex: 1;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    .leaderboard-value {
      font-size: 16px;
      font-weight: 600;
      color: var(--accent-color);
    }
    
    .quick-log-books {
      display: flex;
      gap: 8px;
      margin-bottom: 16px;
      flex-wrap: wrap;
    }
    
    .quick-book-btn {
      background: var(--bg-tertiary);
      border: 1px solid var(--border-color);
      color: var(--text-primary);
      padding: 6px 12px;
      border-radius: 16px;
      cursor: pointer;
      font-size: 12px;
      transition: all 0.2s;
    }
    
    .quick-book-btn:hover {
      background: var(--border-color);
      transform: translateY(-1px);
    }
    
    .quick-book-btn.active {
      background: var(--accent-color);
      color: white;
      border-color: var(--accent-color);
    }
    
    .toggle-section-btn {
      background: var(--bg-tertiary);
      border: 1px solid var(--border-color);
      color: var(--text-primary);
      padding: 8px 16px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 13px;
      transition: all 0.2s;
      margin-right: 8px;
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }
    
    .toggle-section-btn:hover {
      background: var(--border-color);
      transform: translateY(-1px);
    }
    
    .toggle-section-btn.active {
      background: var(--accent-color);
      color: white;
      border-color: var(--accent-color);
    }
    
    .toggle-buttons {
      display: flex;
      gap: 8px;
      margin-top: 16px;
      margin-bottom: 8px;
    }
    
    .theme-selector {
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  gap: 12px;
  margin-top: 12px;
  row-gap: 20px;
}

@media (max-width: 600px) {
  .theme-selector {
    grid-template-columns: repeat(2, 1fr);
  }
}
    
    .theme-preview {
  padding: 24px 16px;
  border-radius: 6px;
  cursor: pointer;
  border: 2px solid transparent;
  transition: all 0.2s;
  text-align: center;
  font-size: 13px;
  min-height: 80px;
  display: flex;
  align-items: center;
  justify-content: center;
}
    
    .theme-preview:hover {
      transform: scale(1.05);
    }
    
    .theme-preview.active {
      border-color: var(--accent-color);
      box-shadow: 0 0 16px rgba(35, 134, 54, 0.3);
    }
    
    .theme-preview.default {
      background: linear-gradient(135deg, #0d1117 0%, #161b22 100%);
      color: #c9d1d9;
    }
    
    .theme-preview.nord {
      background: linear-gradient(135deg, #2e3440 0%, #3b4252 100%);
      color: #eceff4;
    }
    
    .theme-preview.tokyo {
      background: linear-gradient(135deg, #1a1b26 0%, #24283b 100%);
      color: #c0caf5;
    }
    
    .theme-preview.dracula {
      background: linear-gradient(135deg, #282a36 0%, #44475a 100%);
      color: #f8f8f2;
    }

    .theme-preview.everforest {
  background: linear-gradient(135deg, #fdf6e3 0%, #f4f0d9 100%);
  color: #5c6a72;
}

.theme-preview.everforest {
  background: linear-gradient(135deg, #fdf6e3 0%, #f3ead3 100%);
  color: #5c6a72;
}

.theme-preview.onedark {
  background: linear-gradient(135deg, #282c34 0%, #21252b 100%);
  color: #abb2bf;
}

.theme-preview.nord-light {
  background: linear-gradient(135deg, #eceff4 0%, #e5e9f0 100%);
  color: #2e3440;
}

.theme-preview.phoenix {
  background: linear-gradient(135deg, #170f1e 0%, #1c1521 100%);
  color: #f5c2e7;
}

.theme-preview.ereader {
  background: linear-gradient(135deg, #ffffff 0%, #f5f5f5 100%);
  color: #000000;
  border: 2px solid #d0d0d0;
}

    .year-display {
      color: var(--text-primary);
      font-size: 14px;
      font-weight: 600;
      padding: 8px 14px;
      display: inline-flex;
      align-items: center;
    }

.google-signin-btn {
      padding: 10px 20px;
      display: flex;
      align-items: center;
      gap: 12px;
      background: white;
      color: #3c4043;
      border: 1px solid #dadce0;
      border-radius: 8px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 500;
      transition: all 0.2s ease;
      font-family: 'Roboto', -apple-system, BlinkMacSystemFont, sans-serif;
      box-shadow: 0 1px 2px rgba(0,0,0,0.1);
    }

    .google-signin-btn:hover {
      box-shadow: 0 2px 8px rgba(0,0,0,0.15);
      background: #f8f9fa;
      border-color: #c6c6c6;
      transform: translateY(-1px);
    }

    .google-signin-btn:active {
      transform: translateY(0);
      box-shadow: 0 1px 2px rgba(0,0,0,0.1);
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>Ë™≠Êõ∏</h1>
      <div class="header-actions">
        <div id="authSection"></div>
        <button class="icon-btn" onclick="toggleMenu()" title="Settings">‚öôÔ∏è</button>
      </div>
      <input type="file" id="fileInput" style="display: none;" accept=".json" onchange="loadData(event)">
    </header>

    <div class="controls">
      <button class="btn" onclick="changeYear(-1)">‚Üê Prev</button>
      <span class="year-display" id="yearDisplay">2026</span>
      <button class="btn" onclick="changeYear(1)">Next ‚Üí</button>
      
      <div class="metric-toggle">
        <button class="metric-option active" id="minutesBtn" onclick="switchMetric('minutes')">Minutes</button>
        <button class="metric-option" id="charactersBtn" onclick="switchMetric('characters')">Characters</button>
      </div>
    </div>

    <div class="heatmap-panel">
      <div class="calendar-wrapper">
        <div class="day-labels">
          <div class="day-label">Mon</div>
          <div class="day-label"></div>
          <div class="day-label">Wed</div>
          <div class="day-label"></div>
          <div class="day-label">Fri</div>
          <div class="day-label"></div>
          <div class="day-label"></div>
        </div>
        <div id="calendar" class="calendar"></div>
      </div>
      
      <div class="stats-section">
        <div class="stats">
          <div class="stat-line">
            <span>Longest streak:</span>
            <span class="stat-value" id="longestStreak">0 days</span>
          </div>
          <div class="stat-line">
            <span>Streak:</span>
            <span class="stat-value" id="currentStreak">0 days</span>
          </div>
          <div class="stat-line">
            <span>Average:</span>
            <span class="stat-value" id="avgValue">0</span>
          </div>
          <div class="stat-line">
            <span>Total:</span>
            <span class="stat-value" id="totalValue">0</span>
          </div>
        </div>
        
        <button class="log-btn" onclick="openModalForToday()">
          Log today ‚Üí
        </button>
      </div>

      <div class="legend">
        <span>Less</span>
        <div class="legend-item" style="background: var(--level-0); border: 1px solid var(--border-color);"></div>
        <div class="legend-item" style="background: var(--level-1);"></div>
        <div class="legend-item" style="background: var(--level-2);"></div>
        <div class="legend-item" style="background: var(--level-3);"></div>
        <div class="legend-item" style="background: var(--level-4);"></div>
        <span>More</span>
      </div>
    </div>
    
    <div class="toggle-buttons">
      <button class="toggle-section-btn" id="goalsToggle" onclick="toggleGoalsSection()">
        üéØ Goals
      </button>
      <button class="toggle-section-btn" id="leaderboardToggle" onclick="toggleLeaderboardSection()">
        üèÜ Leaderboard
      </button>
    </div>
    
    <div class="goals-section" id="goalsSection" style="display: none;">
      <h3 style="margin-bottom: 12px; font-size: 16px;">Goals</h3>
      <div id="goalsList"></div>
      <button class="btn" onclick="addGoal()" style="margin-top: 12px; width: 100%;">+ Add Goal</button>
    </div>
    
    <div class="leaderboard-panel" id="leaderboardPanel" style="display: none;">
      <h2 style="margin-bottom: 16px;">Leaderboard</h2>
      <div id="leaderboardList"></div>
    </div>
  </div>

  <div class="tooltip" id="tooltip">
    <div class="tooltip-date" id="tooltipDate"></div>
    <div class="tooltip-value" id="tooltipValue"></div>
    <div class="tooltip-titles" id="tooltipTitles"></div>
  </div>

  <div class="modal" id="modal">
    <div class="modal-content">
      <h2>Log reading data</h2>
      <div id="quickLogBooks" class="quick-log-books"></div>
      <div class="form-group">
        <label class="form-label">Date</label>
        <input type="text" class="form-input" id="modalDate" readonly>
      </div>
      <div class="form-row">
        <div class="form-group">
          <label class="form-label">Minutes</label>
          <input type="number" class="form-input" id="modalMinutes" min="0" placeholder="60">
        </div>
        <div class="form-group">
          <label class="form-label">Characters</label>
          <input type="number" class="form-input" id="modalCharacters" min="0" placeholder="10000">
        </div>
      </div>
      <div class="form-group">
        <label class="form-label">Titles (one per line)</label>
        <textarea class="form-input" id="modalTitles" placeholder="Book title 1
Book title 2"></textarea>
      </div>
      <div class="entry-list" id="entryList"></div>
      <div class="modal-actions">
        <button class="btn" onclick="closeModal()">Cancel</button>
        <button class="log-btn" onclick="saveEntry()">Save</button>
      </div>
    </div>
  </div>

  <div class="modal" id="menuModal">
  <div class="modal-content" style="width: 560px; max-width: 95vw;">
    <h2>Settings</h2>
    
    <div style="margin-bottom: 20px;">
      <h3 style="font-size: 14px; margin-bottom: 12px; color: var(--text-secondary);">Theme</h3>
      <div class="theme-selector">
        <div class="theme-preview default" onclick="setTheme('default')">
          <div>GitHub Dark</div>
        </div>
        <div class="theme-preview nord" onclick="setTheme('nord')">
          <div>Nord</div>
        </div>
        <div class="theme-preview tokyo" onclick="setTheme('tokyo')">
          <div>Tokyo Night</div>
        </div>
        <div class="theme-preview dracula" onclick="setTheme('dracula')">
          <div>Dracula</div>
        </div>
        <div class="theme-preview everforest" onclick="setTheme('everforest')">
          <div>Everforest</div>
        </div>
        <div class="theme-preview onedark" onclick="setTheme('onedark')">
          <div>One Dark</div>
        </div>
        <div class="theme-preview nord-light" onclick="setTheme('nord-light')">
          <div>Nord Light</div>
        </div>
        <div class="theme-preview phoenix" onclick="setTheme('phoenix')">
          <div>Phoenix Night</div>
        </div>
        <div class="theme-preview ereader" onclick="setTheme('ereader')">
          <div>E-Reader</div>
        </div>
      </div>
    </div>
    
    <div style="border-top: 1px solid var(--border-color); padding-top: 16px; margin-top: 16px;">
      <button class="btn" onclick="exportToToggl()" style="width: 100%; margin-bottom: 8px;">‚è±Ô∏è Export to Toggl</button>
      <button class="btn" onclick="downloadData()" style="width: 100%; margin-bottom: 8px;">üíæ Download data</button>
      <button class="btn" onclick="document.getElementById('fileInput').click()" style="width: 100%; margin-bottom: 8px;">üìÇ Load data</button>
      <button class="btn" onclick="wipeAllData()" style="width: 100%; margin-bottom: 8px; background: var(--danger-color); border-color: rgba(255, 0, 0, 0.3);">üóëÔ∏è Wipe all data!</button>
    </div>
    
    <button class="btn" onclick="closeMenu()" style="width: 100%; margin-top: 12px;">Close</button>
  </div>
</div>
  
  <div class="modal" id="goalModal">
    <div class="modal-content">
      <h2>Set Goal</h2>
      <div class="form-group">
        <label class="form-label">Goal Type</label>
        <select class="form-input" id="goalType">
          <option value="daily_minutes">Daily Minutes</option>
          <option value="daily_characters">Daily Characters</option>
          <option value="weekly_minutes">Weekly Minutes</option>
          <option value="weekly_characters">Weekly Characters</option>
          <option value="streak">Streak (days)</option>
        </select>
      </div>
      <div class="form-group">
        <label class="form-label">Target</label>
        <input type="number" class="form-input" id="goalTarget" min="1" placeholder="60">
      </div>
      <div class="modal-actions">
        <button class="btn" onclick="closeGoalModal()">Cancel</button>
        <button class="log-btn" onclick="saveGoal()">Save Goal</button>
      </div>
    </div>
  </div>

  <script>
    const STORAGE_KEY = 'reading_heatmap_data';
    const GOALS_KEY = 'reading_heatmap_goals';
    const BOOKS_KEY = 'reading_heatmap_books';
    const THEME_KEY = 'reading_heatmap_theme';
    const USER_KEY = 'reading_heatmap_user';
    
    
    let data = [];
    let dailyData = {};
    let goals = [];
    let recentBooks = [];
    let currentUser = null;
    let currentYear = 2026;
    let googleInitialized = false;
    
window.onload = function() {
  loadTheme();
  
  // Initialize empty state - Firebase will load data if user is signed in
  window.data = data = [];
  window.dailyData = dailyData = {};
  window.goals = goals = [];
  window.recentBooks = recentBooks = [];
  window.currentUser = currentUser = null;
  
  // Check if there's a stored user (for faster UI update)
  const storedUser = localStorage.getItem(USER_KEY);
  if (storedUser) {
    try {
      window.currentUser = currentUser = JSON.parse(storedUser);
    } catch (e) {
      console.error('Error loading stored user:', e);
    }
  }
  
  initializeAuthButton();
  renderHeatmap();
  updateStats();
  
  // Warn if not running on server
  if (window.location.protocol === 'file:') {
    alert("Warning: Google Sign-In will NOT work if you open this file directly.\nPlease use a local server (e.g., Live Server in VS Code).");
  }
};

function initializeAuthButton() {
  var el = document.getElementById('authSection');
  if (!el) return;
  
  if (window.currentUser) {
    renderUserProfile();
  } else {
    el.innerHTML = '<button class="google-signin-btn" onclick="promptSignIn()">' +
      '<svg width="18" height="18" viewBox="0 0 18 18" xmlns="http://www.w3.org/2000/svg">' +
      '<path fill="#4285F4" d="M17.64 9.2c0-.637-.057-1.251-.164-1.84H9v3.481h4.844c-.209 1.125-.843 2.078-1.796 2.717v2.258h2.908c1.702-1.567 2.684-3.874 2.684-6.615z"/>' +
      '<path fill="#34A853" d="M9 18c2.43 0 4.467-.806 5.956-2.184l-2.908-2.258c-.806.54-1.837.86-3.048.86-2.344 0-4.328-1.584-5.036-3.711H.957v2.332C2.438 15.983 5.482 18 9 18z"/>' +
      '<path fill="#FBBC05" d="M3.964 10.707c-.18-.54-.282-1.117-.282-1.707s.102-1.167.282-1.707V4.961H.957C.347 6.175 0 7.55 0 9s.348 2.825.957 4.039l3.007-2.332z"/>' +
      '<path fill="#EA4335" d="M9 3.58c1.321 0 2.508.454 3.44 1.345l2.582-2.58C13.463.891 11.426 0 9 0 5.482 0 2.438 2.017.957 4.961L3.964 7.29C4.672 5.163 6.656 3.58 9 3.58z"/>' +
      '</svg>' +
      'Sign in with Google' +
      '</button>';
  }
}

// Make initializeAuthButton globally available for Firebase to call
window.initializeAuthButton = initializeAuthButton;

// Fallback prompt-based sign-in if Google OAuth not configured
function promptSignIn() {
  // Try Firebase sign-in first
  if (window.promptSignIn && typeof window.firebaseSignIn === 'function') {
    window.firebaseSignIn();
    return;
  }
  
  // Fallback to manual sign-in
  const name = prompt('Enter your name:');
  if (!name) return;
  
  const email = prompt('Enter your email (optional):') || 'user@example.com';
  
  currentUser = {
    id: Date.now().toString(),
    name: name,
    email: email,
    avatar: `https://ui-avatars.com/api/?name=${encodeURIComponent(name)}&background=random&size=128`
  };
  
  localStorage.setItem(USER_KEY, JSON.stringify(currentUser));
  renderUserProfile();
  updateLeaderboard();
  alert('Welcome, ' + name + '! You can now use the leaderboard.');
}

function signOut() {
  if (confirm('Sign out of your account?')) {
    if (window.firebaseSignOut && typeof window.firebaseSignOut === 'function') {
      window.firebaseSignOut();
    } else {
      // Fallback for manual sign-in users
      window.currentUser = null;
      currentUser = null;
      localStorage.removeItem(USER_KEY);
      initializeAuthButton();
    }
  }
}
    
    function renderUserProfile() {
      const authSection = document.getElementById('authSection');
      // Use window.currentUser instead of currentUser to ensure we're reading the global variable
      if (window.currentUser) {
        authSection.innerHTML = `
          <div class="user-profile" onclick="signOut()" title="Click to sign out">
            <img src="${window.currentUser.avatar}" class="user-avatar" alt="${window.currentUser.name}" onerror="this.src='data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 24 24%22%3E%3Ccircle cx=%2212%22 cy=%2212%22 r=%2212%22 fill=%22%23888%22/%3E%3C/svg%3E'">
            <span class="user-name">${window.currentUser.name}</span>
          </div>
        `;
      }
    }
    
    // Make renderUserProfile globally available for Firebase to call
    window.renderUserProfile = renderUserProfile;
    
    function exportToToggl() {
      const togglData = data.map(entry => ({
        description: entry.title || 'Reading',
        start: `${entry.date}T00:00:00Z`,
        duration: entry.minutes * 60,
        tags: ['reading'],
        created_with: 'Reading Heatmap'
      }));
      
      const blob = new Blob([JSON.stringify(togglData, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'reading-toggl-export.json';
      a.click();
      URL.revokeObjectURL(url);
      
      alert('Exported to Toggl format! Import this file to Toggl Track.');
      closeMenu();
    }

    function getAustralianDate() {
      const now = new Date();
      const australiaTime = new Date(now.toLocaleString('en-US', { timeZone: 'Australia/Sydney' }));
      return australiaTime.toISOString().split('T')[0];
    }

   async function loadFromStorage() {
  // Only load from cloud storage when user is signed in
  if (!window.currentUser && !currentUser) {
    window.data = data = [];
    window.dailyData = dailyData = {};
    window.goals = goals = [];
    window.recentBooks = recentBooks = [];
    aggregateData();
    loadYear();
    renderGoals();
    return;
  }
  
  // Data is loaded from Firebase in firebaseSignIn
  // This function just refreshes the UI
  aggregateData();
  loadYear();
  renderGoals();
}

    async function saveToStorage() {
  // Don't save to localStorage anymore - only cloud
  // The Firebase hooks will handle cloud saves
  
  try {
    localStorage.setItem('reading_heatmap_sync_signal', Date.now().toString());
  } catch (e) {}
}

    function aggregateData() {
  window.dailyData = dailyData = {};
  const dataArray = window.data || data || [];
  dataArray.forEach(item => {
    if (!dailyData[item.date]) {
      dailyData[item.date] = { minutes: 0, characters: 0, titles: [] };
    }
    dailyData[item.date].minutes += item.minutes;
    dailyData[item.date].characters += item.characters;
    if (item.title && !dailyData[item.date].titles.includes(item.title)) {
      dailyData[item.date].titles.push(item.title);
    }
  });
  window.dailyData = dailyData;
}

    function loadYear() {
      document.getElementById('yearDisplay').textContent = currentYear;
      renderHeatmap();
      updateStats();
    }

    function changeYear(delta) {
      currentYear = currentYear + delta;
      loadYear();
    }

    function switchMetric(metric) {
      document.getElementById('minutesBtn').classList.toggle('active', metric === 'minutes');
      document.getElementById('charactersBtn').classList.toggle('active', metric === 'characters');
      
      localStorage.setItem('selectedMetric', metric);
      renderHeatmap();
      updateStats();
    }

    function getSelectedMetric() {
      const stored = localStorage.getItem('selectedMetric');
      return stored || 'minutes';
    }

    function renderHeatmap() {
      const year = currentYear;
      const metric = getSelectedMetric();
      const calendar = document.getElementById('calendar');
      calendar.innerHTML = '';

      const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
      
      const startDate = new Date(year, 0, 1);
      const endDate = new Date(year, 11, 31);
      
      let currentDate = new Date(startDate);
      let currentMonth = -1;
      let weekDiv = null;
      let monthDiv = null;
      
      while (currentDate <= endDate) {
        if (currentDate.getDay() === 0) {
          weekDiv = document.createElement('div');
          weekDiv.className = 'week';
        }
        
        if (!weekDiv) {
          weekDiv = document.createElement('div');
          weekDiv.className = 'week';
        }
        
        const month = currentDate.getMonth();
        if (month !== currentMonth) {
          currentMonth = month;
          monthDiv = document.createElement('div');
          monthDiv.className = 'month';
          
          const label = document.createElement('div');
          label.className = 'month-label';
          label.textContent = months[month];
          monthDiv.appendChild(label);
          
          const weeksContainer = document.createElement('div');
          weeksContainer.className = 'weeks';
          monthDiv.appendChild(weeksContainer);
          
          calendar.appendChild(monthDiv);
        }
        
        const dayDiv = document.createElement('div');
        dayDiv.className = 'day';
        
        const dateStr = currentDate.toISOString().split('T')[0];
        const today = getAustralianDate();
        
        if (dateStr === today) {
          dayDiv.classList.add('today');
        }
        
        const dayData = dailyData[dateStr];
        
        if (dayData) {
          const value = dayData[metric];
          const level = getLevel(value, metric);
          dayDiv.className += ` level-${level}`;
        } else {
          dayDiv.className += ' empty';
        }
        
        dayDiv.dataset.date = dateStr;
        dayDiv.addEventListener('mouseenter', showTooltip);
        dayDiv.addEventListener('mouseleave', hideTooltip);
        dayDiv.addEventListener('click', () => openModal(dateStr));
        
        weekDiv.appendChild(dayDiv);
        
        if (currentDate.getDay() === 6) {
          const weeksContainer = monthDiv.querySelector('.weeks');
          if (weeksContainer) {
            weeksContainer.appendChild(weekDiv);
          }
          weekDiv = null;
        }
        
        currentDate.setDate(currentDate.getDate() + 1);
      }
      
      if (weekDiv && monthDiv) {
        const weeksContainer = monthDiv.querySelector('.weeks');
        if (weeksContainer) {
          weeksContainer.appendChild(weekDiv);
        }
      }
    }

    function getLevel(value, metric) {
      if (value === 0) return 0;
      const thresholds = metric === 'minutes' 
        ? [1, 30, 60, 90] 
        : [1, 3000, 6000, 10000];
      
      for (let i = thresholds.length - 1; i >= 0; i--) {
        if (value >= thresholds[i]) return i + 1;
      }
      return 1;
    }

    function showTooltip(e) {
      const tooltip = document.getElementById('tooltip');
      const dateStr = e.target.dataset.date;
      const dayData = dailyData[dateStr] || { minutes: 0, characters: 0, titles: [] };
      const metric = getSelectedMetric();
      
      const date = new Date(dateStr + 'T00:00:00');
      document.getElementById('tooltipDate').textContent = 
        date.toLocaleDateString('en-US', { weekday: 'short', year: 'numeric', month: 'short', day: 'numeric' });
      
      const value = dayData[metric];
      document.getElementById('tooltipValue').textContent = 
        metric === 'minutes' 
          ? `${value} minutes reading`
          : `${value.toLocaleString()} characters`;
      
      const titlesDiv = document.getElementById('tooltipTitles');
      if (dayData.titles.length > 0) {
        titlesDiv.style.display = 'block';
        titlesDiv.textContent = dayData.titles.join(', ');
      } else {
        titlesDiv.style.display = 'none';
      }
      
      tooltip.className = 'tooltip show';
      
      const rect = e.target.getBoundingClientRect();
      tooltip.style.left = (rect.left + rect.width / 2) + 'px';
      tooltip.style.top = (rect.top - 10) + 'px';
      tooltip.style.transform = 'translate(-50%, -100%)';
    }

    function hideTooltip() {
      document.getElementById('tooltip').className = 'tooltip';
    }

    function updateStats() {
      const year = currentYear;
      const metric = getSelectedMetric();
      
      let longestStreak = 0, currentStreak = 0, streak = 0;
      let total = 0, count = 0;
      
      const startDate = new Date(year, 0, 1);
      const endDate = new Date(year, 11, 31);
      const today = new Date();
      
      for (let d = new Date(startDate); d <= endDate; d.setDate(d.getDate() + 1)) {
        const dateStr = d.toISOString().split('T')[0];
        const dayData = dailyData[dateStr];
        const value = dayData ? dayData[metric] : 0;
        
        total += value;
        count++;
        
        if (value > 0) {
          streak++;
          longestStreak = Math.max(longestStreak, streak);
        } else {
          streak = 0;
        }
      }
      
      streak = 0;
      for (let d = new Date(today); d.getFullYear() === year; d.setDate(d.getDate() - 1)) {
        const dateStr = d.toISOString().split('T')[0];
        const dayData = dailyData[dateStr];
        if (dayData && dayData[metric] > 0) {
          streak++;
        } else {
          break;
        }
      }
      currentStreak = streak;
      
      const avg = count > 0 ? total / count : 0;
      const suffix = metric === 'minutes' ? ' minutes' : ' characters';
      
      document.getElementById('longestStreak').textContent = `${longestStreak} days`;
      document.getElementById('currentStreak').textContent = `${currentStreak} days`;
      document.getElementById('avgValue').textContent = Math.round(avg).toLocaleString() + suffix;
      document.getElementById('totalValue').textContent = Math.round(total).toLocaleString() + suffix;
    }

    function openModal(dateStr) {
      const modal = document.getElementById('modal');
      const dayData = dailyData[dateStr] || { minutes: 0, characters: 0, titles: [] };
      
      document.getElementById('modalDate').value = dateStr;
      document.getElementById('modalMinutes').value = dayData.minutes || '';
      document.getElementById('modalCharacters').value = dayData.characters || '';
      document.getElementById('modalTitles').value = dayData.titles.join('\n');
      
      renderQuickLogBooks();
      renderEntryList(dateStr);
      
      modal.className = 'modal show';
    }
    
    function renderQuickLogBooks() {
      const container = document.getElementById('quickLogBooks');
      if (recentBooks.length === 0) {
        container.innerHTML = '';
        return;
      }
      
      container.innerHTML = '';
      recentBooks.slice(0, 3).forEach(book => {
        const btn = document.createElement('button');
        btn.className = 'quick-book-btn';
        btn.textContent = book;
        btn.onclick = () => {
          const currentTitles = document.getElementById('modalTitles').value;
          if (!currentTitles.includes(book)) {
            document.getElementById('modalTitles').value = currentTitles ? currentTitles + '\n' + book : book;
          }
          btn.classList.add('active');
          setTimeout(() => btn.classList.remove('active'), 300);
        };
        container.appendChild(btn);
      });
    }

    function openModalForToday() {
      const today = getAustralianDate();
      openModal(today);
    }

    function closeModal() {
      document.getElementById('modal').className = 'modal';
    }

    function renderEntryList(dateStr) {
      const entryList = document.getElementById('entryList');
      const dateEntries = data.filter(item => item.date === dateStr);
      
      if (dateEntries.length === 0) {
        entryList.innerHTML = '';
        return;
      }
      
      entryList.innerHTML = '<div style="color: var(--text-secondary); font-size: 12px; margin-bottom: 8px;">Entries for this date:</div>';
      
      dateEntries.forEach((entry, index) => {
        const entryDiv = document.createElement('div');
        entryDiv.className = 'entry-item';
        
        let content = '';
        if (entry.title) {
          content = `<strong>${entry.title}</strong>`;
          if (entry.minutes > 0 || entry.characters > 0) {
            content += `<br><span class="entry-detail">${entry.minutes} min, ${entry.characters.toLocaleString()} chars</span>`;
          }
        } else {
          content = `<strong>${entry.minutes} min</strong><br><span class="entry-detail">${entry.characters.toLocaleString()} characters</span>`;
        }
        
        entryDiv.innerHTML = `
          <div class="entry-info">${content}</div>
          <button class="delete-btn" onclick="deleteEntry('${dateStr}', ${index})">Delete</button>
        `;
        
        entryList.appendChild(entryDiv);
      });
    }

    async function deleteEntry(dateStr, index) {
  const dateEntries = window.data.filter(item => item.date === dateStr);
  if (dateEntries[index]) {
    const entryToDelete = dateEntries[index];
    window.data = window.data.filter(item => !(item.date === dateStr && 
      item.minutes === entryToDelete.minutes && 
      item.characters === entryToDelete.characters && 
      item.title === entryToDelete.title));
    
    // Sync with local variable
    data = window.data;
    
    await saveToStorage();
    aggregateData();
    renderEntryList(dateStr);
    loadYear();
    
    // Trigger cloud save if available
    if (window.saveCloudState && typeof window.saveCloudState === 'function') {
      await window.saveCloudState();
    }
  }
}

    async function saveEntry() {
  const dateStr = document.getElementById('modalDate').value;
  const minutes = parseInt(document.getElementById('modalMinutes').value) || 0;
  const characters = parseInt(document.getElementById('modalCharacters').value) || 0;
  const titles = document.getElementById('modalTitles').value
    .split('\n')
    .map(t => t.trim())
    .filter(Boolean);
  
  titles.forEach(title => {
    if (!recentBooks.includes(title)) {
      recentBooks.unshift(title);
      recentBooks = recentBooks.slice(0, 10);
    }
  });
  
  // Update both local and window variables
  window.recentBooks = recentBooks;
  
  data = data.filter(item => item.date !== dateStr);
  
  if (titles.length > 0) {
    data.push({ date: dateStr, minutes, characters, title: titles[0] });
    titles.slice(1).forEach(title => {
      data.push({ date: dateStr, minutes: 0, characters: 0, title });
    });
  } else {
    data.push({ date: dateStr, minutes, characters, title: null });
  }
  
  // Sync with window
  window.data = data;
  
  await saveToStorage();
  aggregateData();
  loadYear();
  renderGoals();
  closeModal();
  
  // Trigger cloud save if available
  if (window.saveCloudState && typeof window.saveCloudState === 'function') {
    await window.saveCloudState();
  }
}

    function downloadData() {
      const exportData = {
        data: window.data || [],
        goals: window.goals || [],
        recentBooks: window.recentBooks || [],
        exportDate: new Date().toISOString(),
        user: window.currentUser ? {
          name: window.currentUser.name,
          email: window.currentUser.email
        } : null
      };
      
      const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `reading-heatmap-backup-${new Date().toISOString().split('T')[0]}.json`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
      closeMenu();
    }

    function loadData(event) {
  const file = event.target.files[0];
  if (!file) return;

  const reader = new FileReader();
  reader.onload = async function(e) {
    try {
      const imported = JSON.parse(e.target.result);
      
      let importedData = [];
      let importedGoals = [];
      let importedBooks = [];
      
      if (Array.isArray(imported)) {
        importedData = imported;
      } else if (imported.data) {
        importedData = imported.data || [];
        importedGoals = imported.goals || [];
        importedBooks = imported.recentBooks || [];
      } else {
        alert('Invalid data format.');
        return;
      }
      
      if (importedData.length > 0 && confirm('Replace existing data?')) {
        window.data = importedData;
        window.goals = importedGoals;
        window.recentBooks = importedBooks;
      } else if (importedData.length > 0) {
        window.data = [...window.data, ...importedData];
        window.goals = [...window.goals, ...importedGoals];
        window.recentBooks = [...new Set([...window.recentBooks, ...importedBooks])];
      }
      
      // Sync with local variables
      data = window.data;
      goals = window.goals;
      recentBooks = window.recentBooks;
      
      await saveToStorage();
      aggregateData();
      loadYear();
      renderGoals();
      
      if (window.saveCloudState && typeof window.saveCloudState === 'function') {
        await window.saveCloudState();
      }
      
      closeMenu();
      alert('Data loaded successfully!');
    } catch (error) {
      alert('Error reading file: ' + error.message);
    }
  };
  
  reader.readAsText(file);
  event.target.value = '';
}

    function toggleMenu() {
      const modal = document.getElementById('menuModal');
      modal.className = 'modal show';
      updateThemeSelection();
    }

    function closeMenu() {
      document.getElementById('menuModal').className = 'modal';
    }

    function wipeAllData() {
      if (confirm('Are you sure? This will permanently delete all data. This action cannot be undone.')) {
        if (confirm('Really delete ALL data? Click OK to confirm.')) {
          data = [];
          dailyData = {};
          goals = [];
          recentBooks = [];
          saveToStorage().then(() => {
            loadYear();
            renderGoals();
            closeMenu();
            alert('All data has been wiped.');
          });
        }
      }
    }

    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape' || e.key === 'Esc') {
        try { hideTooltip(); } catch (err) {}
        try { closeModal(); } catch (err) {}
        try { closeMenu(); } catch (err) {}
        try { closeGoalModal(); } catch (err) {}

        try {
          const active = document.activeElement;
          if (active && (active.tagName === 'INPUT' || active.tagName === 'TEXTAREA' || active.tagName === 'BUTTON' || active.isContentEditable)) {
            active.blur();
          }
        } catch (err) {}
      }
    });

    document.getElementById('modal').addEventListener('click', (e) => {
      if (e.target.id === 'modal') closeModal();
    });
    document.getElementById('menuModal').addEventListener('click', (e) => {
      if (e.target.id === 'menuModal') closeMenu();
    });
    
    function loadTheme() {
      const theme = localStorage.getItem(THEME_KEY) || 'default';
      setTheme(theme, false);
    }
    
    function setTheme(theme, save = true) {
      document.body.className = theme === 'default' ? '' : `theme-${theme}`;
      if (save) {
        localStorage.setItem(THEME_KEY, theme);
        updateThemeSelection();
      }
    }
    
    function updateThemeSelection() {
      const currentTheme = localStorage.getItem(THEME_KEY) || 'default';
      document.querySelectorAll('.theme-preview').forEach(el => {
        const themeClass = el.className.split(' ').find(c => c !== 'theme-preview' && c !== 'active');
        if (themeClass === currentTheme) {
          el.classList.add('active');
        } else {
          el.classList.remove('active');
        }
      });
    }
    
    function toggleGoalsSection() {
      const section = document.getElementById('goalsSection');
      const btn = document.getElementById('goalsToggle');
      const isVisible = section.style.display !== 'none';
      
      section.style.display = isVisible ? 'none' : 'block';
      btn.classList.toggle('active', !isVisible);
    }
    
    function addGoal() {
      document.getElementById('goalModal').className = 'modal show';
    }
    
    function closeGoalModal() {
      document.getElementById('goalModal').className = 'modal';
    }
    
    async function saveGoal() {
  const type = document.getElementById('goalType').value;
  const target = parseInt(document.getElementById('goalTarget').value);
  
  if (!target || target <= 0) {
    alert('Please enter a valid target');
    return;
  }
  
  goals.push({ type, target, id: Date.now() });
  window.goals = goals;
  
  await saveToStorage();
  renderGoals();
  closeGoalModal();
  
  document.getElementById('goalTarget').value = '';
  
  // Trigger cloud save if available
  if (window.saveCloudState && typeof window.saveCloudState === 'function') {
    await window.saveCloudState();
  }
}
    
    function renderGoals() {
      const container = document.getElementById('goalsList');
      if (goals.length === 0) {
        container.innerHTML = '<div style="color: var(--text-secondary); font-size: 13px;">No goals set yet</div>';
        return;
      }
      
      container.innerHTML = '';
      goals.forEach(goal => {
        const progress = calculateGoalProgress(goal);
        const goalDiv = document.createElement('div');
        goalDiv.className = 'goal-item';
        
        const typeText = {
          daily_minutes: 'Daily Minutes',
          daily_characters: 'Daily Characters',
          weekly_minutes: 'Weekly Minutes',
          weekly_characters: 'Weekly Characters',
          streak: 'Streak Days'
        }[goal.type];
        
        goalDiv.innerHTML = `
          <div style="flex: 1;">
            <div style="display: flex; justify-content: space-between; margin-bottom: 4px;">
              <span>${typeText}: ${goal.target}</span>
              <span style="color: var(--accent-color); font-weight: 600;">${progress.current} / ${goal.target}</span>
            </div>
            <div class="goal-progress">
              <div class="goal-progress-bar" style="width: ${Math.min(100, (progress.current / goal.target) * 100)}%"></div>
            </div>
          </div>
          <button class="delete-btn" onclick="deleteGoal(${goal.id})">Delete</button>
        `;
        
        container.appendChild(goalDiv);
      });
    }
    
    function calculateGoalProgress(goal) {
      const today = getAustralianDate();
      const metric = goal.type.includes('minutes') ? 'minutes' : goal.type.includes('characters') ? 'characters' : 'streak';
      
      if (goal.type.startsWith('daily')) {
        const dayData = dailyData[today];
        return { current: dayData ? dayData[metric] : 0, target: goal.target };
      } else if (goal.type.startsWith('weekly')) {
        let total = 0;
        const now = new Date(today);
        for (let i = 0; i < 7; i++) {
          const d = new Date(now);
          d.setDate(d.getDate() - i);
          const dateStr = d.toISOString().split('T')[0];
          const dayData = dailyData[dateStr];
          if (dayData) total += dayData[metric];
        }
        return { current: total, target: goal.target };
      } else if (goal.type === 'streak') {
        let streak = 0;
        const now = new Date(today);
        for (let i = 0; i < 365; i++) {
          const d = new Date(now);
          d.setDate(d.getDate() - i);
          const dateStr = d.toISOString().split('T')[0];
          const dayData = dailyData[dateStr];
          if (dayData && (dayData.minutes > 0 || dayData.characters > 0)) {
            streak++;
          } else {
            break;
          }
        }
        return { current: streak, target: goal.target };
      }
      return { current: 0, target: goal.target };
    }
    
async function deleteGoal(id) {
  goals = goals.filter(g => g.id !== id);
  window.goals = goals;
  
  await saveToStorage();
  renderGoals();
  
  // Trigger cloud save if available
  if (window.saveCloudState && typeof window.saveCloudState === 'function') {
    await window.saveCloudState();
  }
}
    
    function toggleLeaderboardSection() {
      const panel = document.getElementById('leaderboardPanel');
      const btn = document.getElementById('leaderboardToggle');
      const isVisible = panel.style.display !== 'none';
      
      panel.style.display = isVisible ? 'none' : 'block';
      btn.classList.toggle('active', !isVisible);
      
      if (!isVisible) {
        loadLeaderboard();
      }
    }
    
  async function loadLeaderboard() {
  const container = document.getElementById('leaderboardList');
  
  if (!currentUser && !window.currentUser) {
    container.innerHTML = '<div style="color: var(--text-secondary); text-align: center; padding: 20px;">Sign in to view the leaderboard and compete with others!</div>';
    return;
  }
  
  try {
    // Check if saveCloudState exists (means Firebase is loaded)
    if (!window.saveCloudState) {
      container.innerHTML = '<div style="color: var(--text-secondary); text-align: center; padding: 20px;">Firebase is loading... Please try again in a moment.</div>';
      return;
    }

    // Use the global loadLeaderboardData function from Firebase module
    if (window.loadLeaderboardData) {
      await window.loadLeaderboardData();
    } else {
      container.innerHTML = '<div style="color: var(--text-secondary); text-align: center; padding: 20px;">Leaderboard not available. Please refresh the page.</div>';
    }
    
  } catch (error) {
    container.innerHTML = '<div style="color: var(--text-secondary); text-align: center; padding: 20px;">Failed to load leaderboard data.</div>';
    console.error('Leaderboard error:', error);
  }
}
// Make all functions globally available
    window.aggregateData = aggregateData;
    window.loadYear = loadYear;
    window.renderGoals = renderGoals;
    window.renderUserProfile = renderUserProfile;
    window.initializeAuthButton = initializeAuthButton;
    window.loadFromStorage = loadFromStorage;
    window.saveEntry = saveEntry;
    window.deleteEntry = deleteEntry;
    window.saveGoal = saveGoal;
    window.deleteGoal = deleteGoal;
    window.wipeAllData = wipeAllData;
    
    // Sync all variables with window
    window.data = data;
    window.dailyData = dailyData;
    window.goals = goals;
    window.recentBooks = recentBooks;
    window.currentUser = currentUser;
    window.currentYear = currentYear;
  </script>
<!-- Firebase integration: Auth (Google) + Firestore -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.0/firebase-app.js";
  import { getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.0.0/firebase-auth.js";
  import { getFirestore, doc, getDoc, setDoc, collection, getDocs } from "https://www.gstatic.com/firebasejs/11.0.0/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyAmGPOSR03tCzi3cftfaP6JTBSk30JUgIw",
    authDomain: "timetracker-79479.firebaseapp.com",
    projectId: "timetracker-79479",
    storageBucket: "timetracker-79479.appspot.com",
    appId: "1:374798694344:web:77b1e15a27fc03ce76b2fd"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  // Listen for auth state changes to persist login across reloads
  // Listen for auth state changes to persist login across reloads
  onAuthStateChanged(auth, async (user) => {
    if (user) {
      window.currentUser = {
        id: user.uid,
        name: user.displayName || 'User',
        email: user.email || '',
        avatar: user.photoURL || `https://ui-avatars.com/api/?name=${encodeURIComponent(user.displayName || 'User')}&background=random&size=128`
      };
      
      // Sync with local variable
      if (typeof currentUser !== 'undefined') {
        currentUser = window.currentUser;
      }
      
      localStorage.setItem('reading_heatmap_user', JSON.stringify(window.currentUser));
      
      // Update UI
      if (window.renderUserProfile) window.renderUserProfile();
      
      // Load user's data from cloud
      await loadCloudState(user.uid);
      
      // Sync all data with local variables
      if (typeof data !== 'undefined') data = window.data;
      if (typeof dailyData !== 'undefined') dailyData = window.dailyData;
      if (typeof goals !== 'undefined') goals = window.goals;
      if (typeof recentBooks !== 'undefined') recentBooks = window.recentBooks;
      
      if (window.aggregateData) window.aggregateData();
      if (window.loadYear) window.loadYear();
      if (window.renderGoals) window.renderGoals();
    } else {
      // User signed out - clear everything
      window.currentUser = null;
      window.data = [];
      window.dailyData = {};
      window.goals = [];
      window.recentBooks = [];
      
      // Sync with local variables
      if (typeof currentUser !== 'undefined') currentUser = null;
      if (typeof data !== 'undefined') data = [];
      if (typeof dailyData !== 'undefined') dailyData = {};
      if (typeof goals !== 'undefined') goals = [];
      if (typeof recentBooks !== 'undefined') recentBooks = [];
      
      localStorage.removeItem('reading_heatmap_user');
      
      if (window.initializeAuthButton) window.initializeAuthButton();
      if (window.aggregateData) window.aggregateData();
      if (window.loadYear) window.loadYear();
      if (window.renderGoals) window.renderGoals();
    }
  });

  async function firebaseSignIn() {
    try {
      const provider = new GoogleAuthProvider();
      provider.setCustomParameters({ prompt: 'select_account' });
      const result = await signInWithPopup(auth, provider);
      // Auth state change listener will handle the rest
    } catch (error) {
      console.error('Sign-in error:', error);
      alert('Sign-in failed: ' + error.message);
    }
  }

  async function firebaseSignOut() {
    try {
      await signOut(auth);
      // Auth state change listener will handle the rest
      alert('Successfully signed out');
    } catch (error) {
      console.error('Sign-out error:', error);
      alert('Sign-out failed: ' + error.message);
    }
  }

  async function loadCloudState(uid) {
    try {
      const ref = doc(db, 'users', uid, 'reading', 'heatmap');
      const snap = await getDoc(ref);
      if (snap.exists()) {
        const cloud = snap.data();
        window.data = Array.isArray(cloud.data) ? cloud.data : [];
        window.goals = Array.isArray(cloud.goals) ? cloud.goals : [];
        window.recentBooks = Array.isArray(cloud.recentBooks) ? cloud.recentBooks : [];
        
        // Sync with local variables
        if (typeof data !== 'undefined') data = window.data;
        if (typeof goals !== 'undefined') goals = window.goals;
        if (typeof recentBooks !== 'undefined') recentBooks = window.recentBooks;
      } else {
        // First time user - initialize empty
        window.data = [];
        window.goals = [];
        window.recentBooks = [];
        
        // Sync with local variables
        if (typeof data !== 'undefined') data = [];
        if (typeof goals !== 'undefined') goals = [];
        if (typeof recentBooks !== 'undefined') recentBooks = [];
        
        await setDoc(ref, { 
          data: [], 
          goals: [], 
          recentBooks: [], 
          lastUpdated: new Date().toISOString() 
        });
      }
    } catch (error) {
      console.error('Error loading cloud state:', error);
      alert('Failed to load your data from cloud. Please try again.');
    }
  }

  async function saveCloudState() {
    if (!window.currentUser) return;
    try {
      const ref = doc(db, 'users', window.currentUser.id, 'reading', 'heatmap');
      await setDoc(ref, {
        data: window.data || [],
        goals: window.goals || [],
        recentBooks: window.recentBooks || [],
        lastUpdated: new Date().toISOString()
      }, { merge: true });
      
      // Also update leaderboard
      await updateCloudLeaderboard();
    } catch (error) {
      console.error('Error saving to cloud:', error);
    }
  }

  async function updateCloudLeaderboard() {
    if (!window.currentUser) return;
    
    let totalMinutes = 0;
    Object.values(window.dailyData || {}).forEach(day => {
      totalMinutes += day.minutes || 0;
    });
    
    const leaderboardEntry = {
      userId: window.currentUser.id,
      name: window.currentUser.name,
      avatar: window.currentUser.avatar,
      totalMinutes: totalMinutes,
      lastUpdated: new Date().toISOString()
    };
    
    try {
      const ref = doc(db, 'leaderboard', window.currentUser.id);
      await setDoc(ref, leaderboardEntry);
    } catch (error) {
      console.error('Failed to update leaderboard:', error);
    }
  }
async function loadLeaderboardData() {
  const container = document.getElementById('leaderboardList');
  
  try {
    const leaderboardRef = collection(db, 'leaderboard');
    const snapshot = await getDocs(leaderboardRef);
    
    const leaderboardData = [];
    snapshot.forEach((docSnap) => {
      const data = docSnap.data();
      // Only include users with more than 0 minutes
      if (data.totalMinutes > 0) {
        leaderboardData.push(data);
      }
    });
    
    if (leaderboardData.length === 0) {
      container.innerHTML = '<div style="color: var(--text-secondary); text-align: center; padding: 20px;">No leaderboard data yet. Be the first to log!</div>';
      return;
    }
    
    leaderboardData.sort((a, b) => b.totalMinutes - a.totalMinutes);
    
    // Find current user's position
    let userPosition = -1;
    if (window.currentUser) {
      userPosition = leaderboardData.findIndex(entry => entry.userId === window.currentUser.id);
    }
    
    // Check if we should show "Show More" button
    const showAll = container.dataset.showAll === 'true';
    const displayCount = showAll ? leaderboardData.length : 10;
    
    container.innerHTML = '';
    
    leaderboardData.slice(0, displayCount).forEach((entry, index) => {
      const rankDiv = document.createElement('div');
      rankDiv.className = 'leaderboard-entry';
      
      // Highlight current user
      const isCurrentUser = window.currentUser && entry.userId === window.currentUser.id;
      if (isCurrentUser) {
        rankDiv.style.background = 'var(--accent-color)';
        rankDiv.style.color = '#ffffff';
        rankDiv.style.fontWeight = '600';
      }
      
      const medal = index === 0 ? 'ü•á' : index === 1 ? 'ü•à' : index === 2 ? 'ü•â' : `#${index + 1}`;
      
      rankDiv.innerHTML = `
        <div class="leaderboard-rank" style="${isCurrentUser ? 'color: #ffffff;' : ''}">${medal}</div>
        <div class="leaderboard-user">
          <img src="${entry.avatar || 'data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 24 24%22%3E%3Ccircle cx=%2212%22 cy=%2212%22 r=%2212%22 fill=%22%23888%22/%3E%3C/svg%3E'}" class="user-avatar" alt="${entry.name}" onerror="this.src='data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 24 24%22%3E%3Ccircle cx=%2212%22 cy=%2212%22 r=%2212%22 fill=%22%23888%22/%3E%3C/svg%3E'" style="width: 32px; height: 32px; border-radius: 50%;">
          <span>${entry.name}${isCurrentUser ? ' (You)' : ''}</span>
        </div>
        <div class="leaderboard-value" style="${isCurrentUser ? 'color: #ffffff;' : ''}">${entry.totalMinutes.toLocaleString()} min</div>
      `;
      
      container.appendChild(rankDiv);
    });
    
    // Add "Show More" / "Show Less" button if there are more than 10 entries
    if (leaderboardData.length > 10) {
      const toggleBtn = document.createElement('button');
      toggleBtn.className = 'btn';
      toggleBtn.style.width = '100%';
      toggleBtn.style.marginTop = '12px';
      toggleBtn.textContent = showAll ? 'Show Less' : `Show More (${leaderboardData.length - 10} more)`;
      toggleBtn.onclick = () => {
        container.dataset.showAll = showAll ? 'false' : 'true';
        loadLeaderboardData();
      };
      container.appendChild(toggleBtn);
    }
    
    // Show user's position if they're not in top 10 but exists in leaderboard
    if (!showAll && userPosition >= 10 && window.currentUser) {
      const userEntry = leaderboardData[userPosition];
      const separatorDiv = document.createElement('div');
      separatorDiv.style.margin = '16px 0 8px 0';
      separatorDiv.style.padding = '8px 0';
      separatorDiv.style.borderTop = '2px dashed var(--border-color)';
      separatorDiv.style.color = 'var(--text-secondary)';
      separatorDiv.style.textAlign = 'center';
      separatorDiv.style.fontSize = '12px';
      separatorDiv.textContent = 'Your Position';
      container.appendChild(separatorDiv);
      
      const userRankDiv = document.createElement('div');
      userRankDiv.className = 'leaderboard-entry';
      userRankDiv.style.background = 'var(--accent-color)';
      userRankDiv.style.color = '#ffffff';
      userRankDiv.style.fontWeight = '600';
      
      userRankDiv.innerHTML = `
        <div class="leaderboard-rank" style="color: #ffffff;">#${userPosition + 1}</div>
        <div class="leaderboard-user">
          <img src="${userEntry.avatar}" class="user-avatar" alt="${userEntry.name}" style="width: 32px; height: 32px; border-radius: 50%;">
          <span>${userEntry.name} (You)</span>
        </div>
        <div class="leaderboard-value" style="color: #ffffff;">${userEntry.totalMinutes.toLocaleString()} min</div>
      `;
      
      container.appendChild(userRankDiv);
    }
    
  } catch (error) {
    container.innerHTML = '<div style="color: var(--text-secondary); text-align: center; padding: 20px;">Error: ' + error.message + '</div>';
    console.error('Leaderboard error details:', error);
  }
}
  // Make functions globally available
  window.firebaseSignIn = firebaseSignIn;
  window.firebaseSignOut = firebaseSignOut;
  window.saveCloudState = saveCloudState;
  window.loadLeaderboardData = loadLeaderboardData;
  // Override promptSignIn to use Firebase
  window.promptSignIn = firebaseSignIn;
</script>

</body>
</html>